<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Studiekompisen SH - Åk 6 (Komplett Läromedel)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; margin: 0; padding: 0; }
        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 20px; border: 4px solid transparent; background-clip: content-box; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        #root { height: 100vh; display: flex; overflow: hidden; }
        
        .split-container { display: flex; flex-direction: column; height: 100%; width: 100%; overflow: hidden; }
        .panel-text { flex: 0 0 60%; min-height: 100px; overflow-y: auto; position: relative; background: white; }
        .drag-handle { 
            height: 12px; 
            background: #f8fafc; 
            cursor: ns-resize; 
            display: flex; 
            align-items: center; 
            justify-content: center;
            border-top: 1px solid #e2e8f0;
            border-bottom: 1px solid #e2e8f0;
            flex-shrink: 0;
            z-index: 40;
            touch-action: none;
        }
        .drag-handle::after { 
            content: ""; 
            width: 48px; 
            height: 4px; 
            background: #cbd5e1; 
            border-radius: 2px; 
        }
        .panel-ai { flex: 1; min-height: 100px; overflow-y: auto; background: #fafafa; display: flex; flex-direction: column; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.5s ease-out forwards; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const MODEL = "gemini-2.5-flash"; 

        // --- DATA: ALLA 7 BLOCK (MAXAT INNEHÅLL FRÅN BOKEN) ---
        const BLOCKS = [
            {
                id: 1, title: "Block 1: Källkritik", icon: "sparkles", sections: [
                    {
                        title: "A: Skröna & Gustav Vasa", page: "8–9",
                        text: "I ämnet historia läser du om hur det var förr i tiden. Men vi måste alltid fråga oss om det vi läser är sant. Ett känt exempel är berättelsen om Gustav Vasa i Dalarna år 1520. Det berättas att bonden Sven Elvsson i Isala räddade kungen genom att gömma honom i ett halmlass. Danska soldater letade efter kungen och stack sina spjut genom halmen. En spjutspets ska ha rispat Gustav i benet. Han låg helt tyst för att inte bli upptäckt. För att dölja blodet tog Sven Elvsson fram sin kniv och skar ett djupt sår i benet på sin häst. När danskarna undrade över blodet visade Sven på hästens sår och de lät honom åka vidare. Den här historien är mycket spännande men den skrevs ner först 250 år senare på order av kung Gustav III. Han ville visa att han var släkt med en hjälte. Historiker kallar detta för en skröna. En skröna är en historia som kan ha en liten kärna av sanning men som är kraftigt överdriven. Syftet är ofta att göra en person mer viktig än vad hen var.",
                        concepts: ["Källkritik", "Skröna", "Historiker", "Syfte"],
                        mustKnow: ["Vad en skröna är.", "Att Vasa-historien kom 250 år efteråt.", "Varför kungar använde propaganda."],
                        summary: ["Källkritik granskar information.", "Skrönor är överdrivna historier.", "Vasa-berättelsen i Isala är en skröna."],
                        test: [{q: "Vad kallas en överdriven historia?", a: "Skröna"}, {q: "Vem beställde texten?", a: "Gustav III"}],
                        reasoning: "Varför ville en kung sprida hjältesagor om sina förfäder?",
                        application: "Hitta en rubrik på nätet och ställ källfrågorna på den."
                    },
                    {
                        title: "B: Källfrågorna", page: "10",
                        text: "För att granska en källa använder vi källkritik. Det finns fyra viktiga grundfrågor. 1. Äkthet: Är källan vad den utger sig för att vara? 2. Tid: Det är bäst om källan skapades precis när något hände. Ju längre tid som går, desto mer glömmer vi. 3. Beroende: Berättar källan något själv eller har den bara skrivit av andra? 4. Syfte: Vad vill författaren uppnå? Vill hen informera, sälja eller påverka? Om en källa är vinklad har den en tendens. Genom att ställa dessa frågor kan vi avgöra om vi kan lita på informationen.",
                        concepts: ["Äkthet", "Tid", "Beroende", "Tendens"],
                        mustKnow: ["De fyra grundfrågorna.", "Varför tid påverkar minnet.", "Vad beroende innebär."],
                        summary: ["Äkthet, Tid, Beroende och Syfte är nyckeln.", "Information nära händelsen är bäst.", "Var vaksam på tendenser."],
                        test: [{q: "Vilken är första frågan?", a: "Äkthet"}, {q: "Vad betyder tendens?", a: "Att källan är vinklad"}],
                        reasoning: "Vilken fråga är svårast att svara på på sociala medier?",
                        application: "Granska ett klipp på TikTok med källkritikens glasögon."
                    }
                ]
            },
            {
                id: 2, title: "Block 2: Ekonomi", icon: "zap", sections: [
                    {
                        title: "A: Pengarnas historia", page: "43–44",
                        text: "Skulle vi klara oss utan pengar? Byteshandel har funnits länge men det är krångligt. För några tusen år sedan uppfanns pengar för att mäta värde. I Sverige var de första mynten av metall. På 1600-talet blev det brist på guld och silver, så man använde koppar istället. Mynten blev enormt tunga – de tyngsta vägde över 19 kilo! Folk fick dra sina pengar på skottkärra. 1660 öppnade Johan Palmstruch den första banken och gav ut kvitton på papper, vilket blev våra första sedlar. Idag är de flesta pengar elektroniska siffror som vi flyttar med kort eller Swish.",
                        concepts: ["Byteshandel", "Kontanter", "Digitala pengar"],
                        mustKnow: ["Varför pengar uppfanns.", "Svenska mynt vägde 19 kg.", "Första banken 1660."],
                        summary: ["Pengar ersatte krånglig byteshandel.", "Första sedlarna var kvitton.", "Idag är pengar främst digitala."],
                        test: [{q: "Vad vägde tunga mynt?", a: "19 kg"}, {q: "Vem startade första banken?", a: "Johan Palmstruch"}],
                        reasoning: "Vad händer om allt digitalt slutar funka?",
                        application: "Designa ett eget mynt."
                    },
                    {
                        title: "B: Brutto & Netto", page: "46–47",
                        text: "När en person arbetar får hen lön. Bruttolön är lönen innan skatten är dragen. I Sverige betalar vi inkomstskatt till staten och kommunen, ofta ca 30%. Det som blir kvar kallas nettolön. Det är nettolönen man använder till mat och hyra. Skattepengarna betalar för skolor, sjukhus, poliser och vägar. Utöver lön kan man få bidrag, som barnbidrag. Genom skatten har vi en offentlig sektor som fungerar för alla, oavsett inkomst.",
                        concepts: ["Bruttolön", "Nettolön", "Skatt", "Offentlig sektor"],
                        mustKnow: ["Brutto vs Netto.", "Skatten är ca 30%.", "Vad skatten betalar."],
                        summary: ["Brutto = före skatt, Netto = efter skatt.", "Skatten betalar välfärd.", "Bidrag hjälper familjer."],
                        test: [{q: "Vad kallas lönen före skatt?", a: "Bruttolön"}, {q: "Vart går skatten?", a: "Offentlig sektor"}],
                        reasoning: "Varför betalar vi inkomstskatt?",
                        application: "Räkna ut netto om brutto är 100 kr."
                    }
                ]
            },
            {
                id: 3, title: "Block 3: Banker & Priser", icon: "landmark", sections: [
                    {
                        title: "A: Banken & Ränta", page: "52–53",
                        text: "Banker fungerar som en mellanhand mellan sparare och lånare. De pengar banken har kommer från människor som sparar. Banken lånar sedan ut dessa till familjer som vill köpa hus eller företag som vill bygga fabriker. Banken tjänar pengar på ränta. Inlåningsränta får du när du sparar. Utlåningsränta betalar du när du lånar. Skillnaden kallas räntegap – det är bankens vinst. Riksbanken är statens bank och styr ekonomin med styrräntan för att motverka inflation.",
                        concepts: ["Räntegap", "Riksbanken", "Inflation", "Styrränta"],
                        mustKnow: ["Banken som mellanhand.", "Räntegapet är bankens vinst.", "Riksbankens roll."],
                        summary: ["Banken kopplar ihop sparare och lånare.", "Ränta är priset på pengar.", "Riksbanken motverkar inflation."],
                        test: [{q: "Vilken ränta är högst?", a: "Utlåningsränta"}, {q: "Vad är räntegapet?", a: "Bankens vinst"}],
                        reasoning: "Hur påverkas en familj om räntan höjs?",
                        application: "Räkna ut räntegapet."
                    },
                    {
                        title: "B: Utbud & Efterfrågan", page: "54–55",
                        text: "Priset på nästan allt styrs av utbud och efterfrågan. Utbud är hur mycket det finns av en vara. Efterfrågan är hur många som vill köpa den. I början av sommaren är jordgubbar dyra för att utbudet är litet men suget stort. När det mognar massor sjunker priset för att locka köpare. Marknadspriset skapas där säljare och köpare möts. Om efterfrågan ökar (t.ex. genom reklam) stiger priset igen.",
                        concepts: ["Utbud", "Efterfrågan", "Marknad", "Prissättning"],
                        mustKnow: ["Litet utbud + hög efterfrågan = dyrt.", "Stort utbud + låg efterfrågan = billigt."],
                        summary: ["Priset styrs av tillgång och sug.", "Jordgubbar är ett bra exempel.", "Marknaden söker jämvikt."],
                        test: [{q: "Vad kallas tillgången?", a: "Utbud"}, {q: "Vad händer vid hög efterfrågan?", a: "Priset stiger"}],
                        reasoning: "Varför sänker affärer priset under REA?",
                        application: "Hitta en vara där priset varierar stort."
                    }
                ]
            },
            {
                id: 4, title: "Block 4: Lag & Rätt", icon: "scale", sections: [
                    {
                        title: "A: Rättskedjan", page: "62–63",
                        text: "Processen börjar hos polisen som utreder brott och säkrar bevis. Åklagaren beslutar om bevisen räcker för åtal. I tingsrätten dömer en domare och tre nämndemän (vanliga människor). Den misstänkte kallas tilltalad och har rätt till en försvarare. Om personen döms får hen en påföljd, som böter eller fängelse. För unga mellan 15 och 18 år finns särskilda regler, som ungdomsvård, eftersom syftet är att hjälpa dem tillbaka.",
                        concepts: ["Åklagare", "Nämndeman", "Påföljd", "Tingsrätt"],
                        mustKnow: ["Stegen i rättskedjan.", "Nämndemännens roll.", "Vad påföljd betyder."],
                        summary: ["Polisen utreder, domstolen dömer.", "Nämndemän representerar folket.", "Påföljd = straff."],
                        test: [{q: "Vem utreder brott?", a: "Polisen"}, {q: "Vem beslutar om åtal?", a: "Åklagaren"}],
                        reasoning: "Varför har vi nämndemän i domstolen?",
                        application: "Rita upp stegen i rättskedjan."
                    },
                    {
                        title: "B: Skollagen & Mobbning", page: "24–25",
                        text: "Skollagen säger att alla barn har rätt att känna sig trygga. Mobbning kallas för 'kränkande behandling'. Det kan vara fysiskt (slag), psykiskt (utfrysning) eller verbalt (elaka ord). Rektorn har huvudansvaret för tryggheten. All personal har anmälningsplikt om en elev känner sig utsatt. Det är alltid offret som avgör om det är en kränkning, inte förövaren. Varje skola måste ha en plan mot kränkningar.",
                        concepts: ["Kränkning", "Anmälningsplikt", "Skollagen"],
                        mustKnow: ["Tre typer av kränkning.", "Anmälningsplikten.", "Offrets tolkningsföreträde."],
                        summary: ["Skollagen skyddar din trygghet.", "Vuxna måste anmäla direkt.", "Offret har alltid rätt om sin känsla."],
                        test: [{q: "Vad kallas mobbning i lagen?", a: "Kränkande behandling"}, {q: "Vem avgör om det är elakt?", a: "Den utsatta"}],
                        reasoning: "Varför är det viktigt att vuxna har anmälningsplikt?",
                        application: "Gör en checklista för en trygg skolgård."
                    }
                ]
            },
            {
                id: 5, title: "Block 5: Demokrati", icon: "users", sections: [
                    {
                        title: "A: Vad är demokrati?", page: "75",
                        text: "Ordet demokrati kommer från grekiskan (demos=folk, kratos=styre). Det betyder folkstyre. I Sverige har vi representativ demokrati: vi väljer politiker som fattar besluten åt oss i riksdagen. Det finns även direkt demokrati, som folkomröstningar eller handuppräckning i klassen. För en fungerande demokrati krävs fria och hemliga val, yttrandefrihet och att alla är lika inför lagen. Motsatsen är diktatur.",
                        concepts: ["Folkstyre", "Representativ", "Direkt demokrati"],
                        mustKnow: ["Ordets betydelse.", "Skillnaden på direkt/representativ.", "Vikten av hemliga val."],
                        summary: ["Demokrati = Folkstyre.", "Vi väljer representanter.", "Motsatsen är diktatur."],
                        test: [{q: "Vad betyder ordet?", a: "Folkstyre"}, {q: "Vilken typ har Sverige?", a: "Representativ"}],
                        reasoning: "Varför röstar vi inte om allt via mobilen?",
                        application: "Ge exempel på direkt demokrati."
                    },
                    {
                        title: "B: Spelregler", page: "76–77",
                        text: "En demokrati kräver: 1. Fria och hemliga val (ingen ser vad du röstar). 2. Yttrandefrihet (tyck och skriv vad du vill). 3. Rättssäkerhet (lagen är lika för alla). 4. Majoritetsprincipen (flest röster vinner, men minoriteter skyddas). Utan dessa spelregler är det ingen riktig demokrati även om det hålls val.",
                        concepts: ["Hemliga val", "Yttrandefrihet", "Rättssäkerhet", "Majoritet"],
                        mustKnow: ["De fyra grundpelarna.", "Varför valen ska vara hemliga."],
                        summary: ["Fria val och yttrandefrihet krävs.", "Lagen skyddar alla lika.", "Minoriteten får inte förtryckas."],
                        test: [{q: "Får man veta vad nån röstat på?", a: "Nej"}, {q: "Vem bestämmer i en röstning?", a: "Majoriteten"}],
                        reasoning: "Vad händer om valen inte vore hemliga?",
                        application: "Gör en checklista för ett demokratiskt land."
                    }
                ]
            },
            {
                id: 6, title: "Block 6: Riksdag & Regering", icon: "landmark", sections: [
                    {
                        title: "A: Hur Sverige styrs", page: "84–87",
                        text: "Riksdagen har 349 ledamöter valda av folket. De stiftar lagar och beslutar om budgeten. Regeringen styr landet och ser till att riksdagens beslut blir verklighet. Statsministern leder regeringen. Vi har parlamentarism, vilket betyder att regeringen måste ha stöd av riksdagen. Regeringen lämnar förslag till riksdagen (propositioner) och ledamöter kan lämna egna förslag (motioner).",
                        concepts: ["Ledamot", "Budget", "Parlamentarism", "Proposition"],
                        mustKnow: ["Riksdagen har 349 ledamöter.", "Skillnad på riksdag och regering.", "Budgetens betydelse."],
                        summary: ["Riksdagen stiftar lagar.", "Regeringen genomför besluten.", "Folket har makten via val."],
                        test: [{q: "Hur många sitter i riksdagen?", a: "349"}, {q: "Vem leder regeringen?", a: "Statsministern"}],
                        reasoning: "Varför bestämmer riksdagen över pengarna?",
                        application: "Hitta namnet på tre partier."
                    },
                    {
                        title: "B: Grundlagarna", page: "85",
                        text: "Sverige har fyra grundlagar som skyddar demokratin: Regeringsformen, Successionsordningen, Tryckfrihetsförordningen och Yttrandefrihetsgrundlagen. De är extra svåra att ändra – det krävs två riksdagsbeslut med ett val emellan. Regeringsformen är den viktigaste eftersom den beskriver hur hela Sverige styrs och våra rättigheter.",
                        concepts: ["Grundlag", "Regeringsformen", "Succession"],
                        mustKnow: ["Namnen på de fyra grundlagarna.", "Hur man ändrar en grundlag."],
                        summary: ["Grundlagar står över vanliga lagar.", "De skyddar demokratin.", "Ändras bara med val emellan."],
                        test: [{q: "Vilken är viktigast?", a: "Regeringsformen"}, {q: "Hur många grundlagar?", a: "Fyra"}],
                        reasoning: "Varför är de svåra att ändra?",
                        application: "Gör ett schema över grundlagarna."
                    }
                ]
            },
            {
                id: 7, title: "Block 7: Framtiden", icon: "briefcase", sections: [
                    {
                        title: "A: Samhällsförändring", page: "29–30",
                        text: "Arbetsmarknaden har ändrats enormt. För 200 år sedan jobbade nästan alla med jordbruk på landet. När industrialiseringen kom byggdes fabriker och folk flyttade till städerna. Idag lever vi i ett tjänstesamhälle där de flesta jobbar inom vård, skola eller teknik. Utbildning har blivit mycket viktigare för att få ett jobb idag än förr. Vi tillverkar inte allt själva längre utan köper tjänster av varandra.",
                        concepts: ["Industrialisering", "Tjänstesamhälle", "Utbildning"],
                        mustKnow: ["Från jordbruk till tjänster.", "Vikten av utbildning idag.", "Städernas växt."],
                        summary: ["Förr jobbade folk med jordbruk.", "Idag jobbar de flesta med tjänster.", "Jobben kräver mer kunskap idag."],
                        test: [{q: "Vad jobbade folk med förr?", a: "Jordbruk"}, {q: "Vad kallas dagens samhälle?", a: "Tjänstesamhälle"}],
                        reasoning: "Hur såg dina morföräldrars jobb ut?",
                        application: "Intervjua en vuxen om deras jobb."
                    },
                    {
                        title: "B: Robotar & AI", page: "31–34",
                        text: "Tekniken ändrar jobben genom mekanisering (maskiner tar tunga lyft) och digitalisering (datorer styr). Robotar finns i fabriker och jobbar dygnet runt. AI (artificiell intelligens) är program som kan lära sig själva. AI används i vården för att hitta sjukdomar och styr självkörande bilar. Yrken med mänsklig kontakt (lärare, frisör) kommer finnas kvar, men verktygen de använder kommer ändras.",
                        concepts: ["Mekanisering", "AI", "Robotisering"],
                        mustKnow: ["Teknikens påverkan på jobb.", "Vad AI står för.", "AI i vården."],
                        summary: ["Robotar tar tunga jobb.", "AI är smarta datorer.", "Mänskliga yrken behövs fortfarande."],
                        test: [{q: "Vad står AI för?", a: "Artificiell intelligens"}, {q: "Vilka jobb försvinner?", a: "Tunga/enformiga"}],
                        reasoning: "Kan en robot bli din lärare?",
                        application: "Leta efter en robot i din vardag."
                    },
                    {
                        title: "C: Barn & Arbete", page: "40",
                        text: "I Sverige skyddas barn av arbetsmiljölagen. Barn får aldrig ha farliga jobb eller jobb som hindrar skolan. Innan 13 år får man bara göra lätta jobb (sälja jultidningar, plocka bär) med föräldrars lov. Mellan 13 och 15 år får man ha lättare extrajobb men inte på natten. FN:s barnkonvention förbjuder barnarbete, men i vissa länder tvingas barn ändå jobba i gruvor istället för att gå i skolan.",
                        concepts: ["Arbetsmiljölagen", "Barnarbete", "Barnkonventionen"],
                        mustKnow: ["Regler för barn under 13 år.", "Skolan går alltid först.", "Vad barnarbete är."],
                        summary: ["Lagar skyddar barn i Sverige.", "Skolan är viktigast.", "Barnarbete är förbjudet av FN."],
                        test: [{q: "Vilken lag skyddar barn?", a: "Arbetsmiljölagen"}, {q: "Får jobb hindra skolan?", a: "Nej"}],
                        reasoning: "Varför finns lagar om barns arbete?",
                        application: "Lista tre säkra jobb för en 13-åring."
                    }
                ]
            }
        ];

        function App() {
            const [activeBlock, setActiveBlock] = useState(0);
            const [activeSection, setActiveSection] = useState(0);
            const [aiChat, setAiChat] = useState([]);
            const [isLoading, setIsLoading] = useState(false);
            const [splitPercent, setSplitPercent] = useState(60);
            const [isTeacherMode, setIsTeacherMode] = useState(false);
            const [history, setHistory] = useState([]);
            const [showDetail, setShowDetail] = useState(null);

            const splitRef = useRef(null);
            const isDragging = useRef(false);

            const block = BLOCKS[activeBlock];
            const section = block.sections[activeSection];

            const onStartDragging = () => { isDragging.current = true; document.body.style.cursor = 'ns-resize'; };
            const onEndDragging = () => { isDragging.current = false; document.body.style.cursor = 'default'; };
            const onDragging = (e) => {
                if (!isDragging.current) return;
                const rect = splitRef.current.getBoundingClientRect();
                const y = (e.clientY || e.touches?.[0].clientY) - rect.top;
                let p = (y / rect.height) * 100;
                if (p < 15) p = 15; if (p > 85) p = 85;
                setSplitPercent(p);
            };

            const askAI = async (type, queryText = "") => {
                setIsLoading(true);
                const userMsg = { role: 'user', content: queryText || `Hjälp med: ${type}` };
                setAiChat(prev => [...prev, userMsg]);

                const sysPrompt = `Du är Studiekompisen AI för årskurs 6. DIN TEXTBANK: "${section.text}" (Sida ${section.page}). REGLER: 1) Endast fakta från textbanken. 2) Inga externa fakta. 3) Resonemang: coacha med frågor. 4) Avsluta alltid med "Källa: sida ${section.page}".`;
                let q = queryText || (type === 'simplify' ? "Förklara texten enklare men behåll fakta." : "Ge ett vardagligt exempel.");

                try {
                    const res = await fetch(`/.netlify/functions/gemini`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ q, systemPrompt: sysPrompt, model: "gemini-2.5-flash" })
                    });
                    const data = await res.json();
                    const aiResponse = data.candidates?.[0]?.content?.parts?.[0]?.text || "Kunde inte hämta svar.";
                    setAiChat(prev => [...prev, { role: 'ai', content: aiResponse }]);
                    setHistory(prev => [...prev, { s: section.page, q: q, a: aiResponse }]);
                } catch (err) {
                    setAiChat(prev => [...prev, { role: 'ai', content: "Anslutningsfel. Kontrollera Netlify-funktionen." }]);
                } finally {
                    setIsLoading(false);
                }
            };

            return (
                <div className="flex w-full h-full text-left" onMouseMove={onDragging} onMouseUp={onEndDragging} onTouchMove={onDragging} onTouchEnd={onEndDragging}>
                    <aside className="w-80 bg-white border-r flex flex-col shrink-0 z-50">
                        <div className="p-8 bg-indigo-700 text-white">
                            <div className="flex items-center gap-3">
                                <span className="bg-white p-2 rounded-lg text-indigo-700"><i data-lucide="graduation-cap"></i></span>
                                <h1 className="text-xl font-black uppercase italic leading-none text-left">Studiekompisen</h1>
                            </div>
                            <p className="text-[10px] mt-2 opacity-70 uppercase font-bold tracking-widest text-left">Utkik SO Åk 6</p>
                        </div>
                        <nav className="flex-1 p-4 overflow-y-auto custom-scrollbar space-y-1">
                            {BLOCKS.map((b, i) => (
                                <button key={i} onClick={() => { setActiveBlock(i); setActiveSection(0); setAiChat([]); }}
                                    className={`w-full flex items-center gap-3 p-4 rounded-2xl transition-all font-bold text-xs ${activeBlock === i ? 'bg-indigo-50 text-indigo-700' : 'text-slate-500 hover:bg-slate-50'}`}>
                                    <span className="p-2 bg-slate-100 rounded-lg"><i data-lucide={b.icon} className="w-4 h-4"></i></span>
                                    {b.title}
                                </button>
                            ))}
                        </nav>
                        <div className="p-4 border-t">
                            <button onClick={() => setIsTeacherMode(!isTeacherMode)} className="w-full p-3 rounded-xl bg-slate-50 text-slate-400 text-[10px] font-black uppercase tracking-widest flex justify-between items-center text-left">
                                Lärarlogg <i data-lucide={isTeacherMode ? "eye" : "eye-off"} className="w-3 h-3"></i>
                            </button>
                        </div>
                    </aside>

                    <main className="flex-1 flex flex-col relative bg-white overflow-hidden" ref={splitRef}>
                        <header className="bg-white/90 border-b p-4 flex items-center justify-between z-10 shrink-0">
                            <div className="flex gap-2 overflow-x-auto no-scrollbar">
                                {block.sections.map((s, i) => (
                                    <button key={i} onClick={() => { setActiveSection(i); setAiChat([]); setShowDetail(null); }}
                                        className={`px-4 py-2 rounded-full text-[10px] font-black uppercase tracking-widest ${activeSection === i ? 'bg-indigo-600 text-white' : 'bg-slate-100 text-slate-400 hover:bg-slate-200'}`}>
                                        {s.title}
                                    </button>
                                ))}
                            </div>
                            <div className="bg-indigo-50 text-indigo-600 px-4 py-1.5 rounded-full text-[10px] font-black uppercase whitespace-nowrap border border-indigo-100">
                                Sida {section.page}
                            </div>
                        </header>

                        <div className="split-container">
                            <div className="panel-text custom-scrollbar" style={{ flexBasis: `${splitPercent}%` }}>
                                <div className="max-w-4xl mx-auto p-8 space-y-12 pb-20 text-left">
                                    <section className="bg-amber-50 p-10 rounded-[3rem] border-4 border-amber-100 shadow-xl relative overflow-hidden">
                                        <h4 className="text-[10px] font-black text-amber-700 uppercase tracking-widest mb-6 flex items-center gap-2 italic text-left">
                                            <i data-lucide="check-circle-2" className="w-4 h-4"></i> Detta behöver du kunna
                                        </h4>
                                        <ul className="space-y-3">
                                            {section.mustKnow.map((m, i) => <li key={i} className="flex gap-4 font-bold text-amber-900 leading-snug"><span className="text-amber-400">▶</span> {m}</li>)}
                                        </ul>
                                    </section>

                                    <section className="bg-white p-12 rounded-[4rem] shadow-2xl border border-slate-100 relative overflow-hidden animate-fade-in text-left">
                                        <div className="absolute top-0 left-0 w-2 h-full bg-indigo-600"></div>
                                        <p className="text-2xl leading-[1.8] text-slate-700 font-bold whitespace-pre-wrap">{section.text}</p>
                                        <div className="mt-14 pt-10 border-t-2 border-slate-50 text-left">
                                            <p className="text-[10px] font-black text-slate-400 uppercase mb-5">Begrepp (klicka för förklaring):</p>
                                            <div className="flex flex-wrap gap-2 text-left">
                                                {section.concepts.map((c, i) => <button key={i} onClick={() => askAI('concept', c)} className="px-5 py-2.5 bg-indigo-50 text-indigo-700 rounded-2xl text-[10px] font-black uppercase tracking-widest hover:bg-indigo-600 hover:text-white transition-all shadow-sm border border-indigo-100">{c}</button>)}
                                            </div>
                                        </div>
                                    </section>

                                    <section className="grid grid-cols-1 md:grid-cols-3 gap-6 font-black uppercase text-[10px] tracking-widest text-left">
                                        <button onClick={() => setShowDetail('summary')} className="p-10 rounded-[2.5rem] border-4 border-slate-100 bg-white text-slate-400 flex flex-col items-center gap-4 hover:border-indigo-200 transition-all text-center"><i data-lucide="list-checks" className="w-10 h-10"></i> Sammanfattning</button>
                                        <button onClick={() => setShowDetail('test')} className="p-10 rounded-[2.5rem] border-4 border-slate-100 bg-white text-slate-400 flex flex-col items-center gap-4 hover:border-blue-200 transition-all text-center"><i data-lucide="zap" className="w-10 h-10"></i> Självtest</button>
                                        <button onClick={() => setShowDetail('reasoning')} className="p-10 rounded-[2.5rem] border-4 border-slate-100 bg-white text-slate-400 flex flex-col items-center gap-4 hover:border-emerald-200 transition-all text-center"><i data-lucide="brain-circuit" className="w-10 h-10"></i> Resonera</button>
                                    </section>

                                    {showDetail && (
                                        <div className="bg-slate-50 p-12 rounded-[3.5rem] border-2 border-slate-100 animate-fade-in text-left">
                                            {showDetail === 'summary' && <ul className="space-y-4">{section.summary.map((s, i) => <li key={i} className="bg-white p-7 rounded-3xl font-bold flex gap-5 shadow-sm leading-tight border border-slate-100 text-left"><span className="text-indigo-500 font-black">0${i+1}</span>{s}</li>)}</ul>}
                                            {showDetail === 'test' && <div className="grid grid-cols-1 md:grid-cols-2 gap-4">{section.test.map((t, i) => <div key={i} className="bg-white p-6 rounded-3xl border border-blue-50 shadow-sm flex flex-col justify-between italic text-sm font-black text-slate-800 text-left text-left">"{t.q}"<button onClick={(e) => { e.currentTarget.innerHTML = `<span class='text-blue-600'>${t.a}</span>`; }} className="text-[9px] text-blue-300 uppercase mt-4 text-left">Visa svar</button></div>)}</div>}
                                            {showDetail === 'reasoning' && <div className="bg-white p-12 rounded-[3rem] italic font-black text-2xl text-slate-700 text-center leading-relaxed text-left text-center">"{section.reasoning}"<button onClick={() => askAI('develop')} className="bg-emerald-600 text-white px-10 py-4 rounded-full text-xs font-black mt-10 uppercase tracking-widest block mx-auto text-center shadow-lg">Hjälp mig tänka vidare</button></div>}
                                        </div>
                                    )}

                                    <section className="bg-slate-900 text-white p-12 rounded-[4rem] shadow-2xl relative overflow-hidden group text-left">
                                        <h4 className="text-[10px] font-black text-indigo-400 uppercase tracking-widest mb-6 italic text-left">Tillämpning: Gör detta nu</h4>
                                        <p className="text-2xl font-bold leading-snug tracking-tight text-left">{section.application}</p>
                                    </section>
                                </div>
                            </div>

                            <div className="drag-handle" onMouseDown={onStartDragging} onTouchStart={onStartDragging}></div>

                            <div className="panel-ai custom-scrollbar p-8 text-left">
                                <div className="max-w-4xl mx-auto w-full space-y-6 text-left">
                                    <div className="flex gap-3 overflow-x-auto no-scrollbar pb-1 text-left">
                                        <button onClick={() => askAI('simplify')} className="bg-indigo-600 text-white px-6 py-4 rounded-2xl text-[10px] font-black uppercase tracking-widest flex items-center gap-3 shadow-lg shrink-0 text-left"><i data-lucide="sparkles" className="w-4 h-4"></i> Förklara enklare</button>
                                        <button onClick={() => askAI('example')} className="bg-slate-900 text-white px-6 py-4 rounded-2xl text-[10px] font-black uppercase tracking-widest flex items-center gap-3 shadow-lg shrink-0 text-left text-left"><i data-lucide="message-square" className="w-4 h-4 text-left text-left"></i> Ge exempel</button>
                                    </div>

                                    {aiChat.map((m, i) => (
                                        <div key={i} className={`flex ${m.role === 'user' ? 'justify-end' : 'justify-start'} animate-fade-in`}>
                                            <div className={`max-w-[85%] p-7 rounded-[2rem] text-sm font-bold shadow-xl leading-relaxed ${m.role === 'user' ? 'bg-indigo-600 text-white rounded-tr-none text-right' : 'bg-white border-2 border-slate-50 text-slate-800 rounded-tl-none text-left'}`}>
                                                {m.role === 'ai' && <div className="text-[9px] uppercase tracking-widest text-indigo-500 mb-3 font-black opacity-60 text-left">Studiekompisen AI</div>}
                                                {m.content}
                                            </div>
                                        </div>
                                    ))}
                                    {isLoading && <div className="flex justify-start text-left"><div className="bg-white p-6 rounded-[2rem] flex items-center gap-5 shadow-xl text-left"><div className="w-6 h-6 border-2 border-indigo-600 border-t-transparent rounded-full animate-spin text-left text-left"></div><span className="text-[10px] font-black text-indigo-400 uppercase animate-pulse italic text-left">Studerar boken...</span></div></div>}
                                </div>
                            </div>
                        </div>
                    </main>

                    {isTeacherMode && (
                        <div className="fixed inset-0 bg-slate-900/80 backdrop-blur-2xl z-[100] flex items-center justify-center p-10">
                            <div className="bg-white w-full max-w-6xl h-[90vh] rounded-[5rem] flex flex-col overflow-hidden border-4 border-white shadow-2xl">
                                <header className="p-14 border-b flex justify-between items-center bg-slate-50/50 text-left">
                                    <h2 className="text-4xl font-black uppercase italic text-slate-900 leading-none text-left">Kontrollpanel</h2>
                                    <button onClick={() => setIsTeacherMode(false)} className="bg-white p-5 rounded-full border-2 border-slate-100 hover:text-red-500 transition-all shadow-sm text-left"><i data-lucide="x"></i></button>
                                </header>
                                <div className="flex-1 overflow-y-auto p-14 custom-scrollbar text-left text-left">
                                    <table className="w-full text-left text-left">
                                        <thead className="bg-slate-50 text-[11px] font-black text-slate-500 uppercase italic border-b-4 border-white text-left text-left"><tr><th className="p-10">Sida</th><th className="p-10">Elevens Input</th><th className="p-10">AI-svar</th></tr></thead>
                                        <tbody className="text-base font-bold text-slate-600 divide-y-4 divide-slate-50 text-left text-left">
                                            {history.map((h, i) => (
                                                <tr key={i} className="hover:bg-indigo-50/30 transition-colors">
                                                    <td className="p-10 text-xs font-black italic whitespace-nowrap text-left text-left text-left">SIDA {h.s}</td>
                                                    <td className="p-10 italic text-slate-900 text-lg text-left text-left">"{h.q}"</td>
                                                    <td className="p-10 text-sm font-medium opacity-60 leading-relaxed max-w-lg text-left text-left">{h.a}</td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);

        setTimeout(() => { if (window.lucide) window.lucide.createIcons(); }, 100);
    </script>
</body>
</html>
