<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Studiekompisen SH - Åk 6</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- React & Babel for CDN usage -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; margin: 0; padding: 0; }
        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 20px; border: 4px solid transparent; background-clip: content-box; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        #root { height: 100vh; display: flex; overflow: hidden; }
        
        /* Split View Layout */
        .split-container { display: flex; flex-direction: column; height: 100%; width: 100%; overflow: hidden; }
        .panel-text { flex: 0 0 60%; min-height: 100px; overflow-y: auto; position: relative; background: white; }
        .drag-handle { 
            height: 12px; 
            background: #f8fafc; 
            cursor: ns-resize; 
            display: flex; 
            align-items: center; 
            justify-content: center;
            border-top: 1px solid #e2e8f0;
            border-bottom: 1px solid #e2e8f0;
            flex-shrink: 0;
            z-index: 40;
            touch-action: none;
        }
        .drag-handle::after { 
            content: ""; 
            width: 48px; 
            height: 4px; 
            background: #cbd5e1; 
            border-radius: 2px; 
        }
        .panel-ai { flex: 1; min-height: 100px; overflow-y: auto; background: #fafafa; display: flex; flex-direction: column; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.5s ease-out forwards; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- DATA: ALLA 7 BLOCK (MAXAT INNEHÅLL) ---
        const BLOCKS = [
            {
                id: 1, title: "Block 1: Källkritik", icon: "sparkles", sections: [
                    {
                        title: "A: Skröna & Berättelse", page: "8–9",
                        text: "I ämnet historia läser du om hur det var förr i tiden. Men vi måste alltid fråga oss om det vi läser är sant. Ett känt exempel är berättelsen om Gustav Vasa i Dalarna år 1520. Det berättas att bonden Sven Elvsson i Isala räddade kungen genom att gömma honom i ett halmlass. Danska soldater letade efter kungen och stack sina spjut genom halmen. En spjutspets ska ha rispat Gustav i benet. Han låg helt tyst för att inte bli upptäckt. För att dölja blodet som rann ut i snön tog Sven Elvsson fram sin kniv. Han skar ett djupt sår i benet på sin häst. När danskarna undrade över blodet visade Sven på hästens sår och de lät honom åka vidare. Den här historien skrevs ner först 250 år senare på order av kung Gustav III. Han ville visa att han var släkt med en hjälte. Historiker kallar detta för en skröna. En skröna är en historia med en liten kärna av sanning som är kraftigt överdriven. Syftet är ofta att göra en person mer viktig än vad hen var.",
                        concepts: ["Källkritik", "Skröna", "Fakta", "Historiker", "Syfte"],
                        mustKnow: ["Skillnaden mellan en skröna och fakta.", "Att Gustav Vasa-historien skrevs ner 250 år senare.", "Varför kungar använde historier som propaganda."],
                        summary: ["Källkritik granskar information.", "En skröna är en överdriven berättelse.", "Vasa-berättelsen i Isala dök upp 250 år efteråt."],
                        test: [{q: "Vad kallas en överdriven historia?", a: "Skröna"}, {q: "Vem beställde texten 250 år senare?", a: "Gustav III"}, {q: "Var gömde Sven kungen?", a: "I ett halmlass"}],
                        reasoning: "Varför tror du att en kung ville sprida hjältesagor om sina förfäder?",
                        application: "Hitta en rubrik på nätet och ställ de 4 källfrågorna på den."
                    },
                    {
                        title: "B: Källkritikens frågor", page: "10",
                        text: "För att granska en källa använder vi källkritik. Det finns fyra viktiga grundfrågor. 1. Äkthet: Är källan vad den utger sig för att vara eller om den är förfalskad? 2. Tid: Det är bäst om källan skapades precis när något hände. Ju längre tid som går, desto mer glömmer vi bort eller ändrar detaljer i vår berättelse. 3. Beroende: Berättar källan något helt själv eller har den bara skrivit av någon annan? 4. Syfte: Vad vill författaren uppnå? Vill hen informera, sälja något eller få oss att tycka på ett visst sätt? Om en källa är vinklad har den en tendens.",
                        concepts: ["Äkthet", "Beroende", "Tendens", "Källa", "Pålitlig"],
                        mustKnow: ["De fyra grundfrågorna i källkritik.", "Varför tiden påverkar minnet.", "Vad det innebär att vara en beroende källa."],
                        summary: ["Äkthet betyder att källan inte är falsk.", "Tid handlar om när källan skapades.", "Syfte handlar om vad författaren vill uppnå."],
                        test: [{q: "Vilken är den första källfrågan?", a: "Äkthet"}, {q: "Vad betyder tendens?", a: "Att källan är vinklad"}, {q: "Vad är beroende?", a: "Att man skrivit av andra"}],
                        reasoning: "Vilken av de fyra frågorna tycker du är viktigast när du läser nyheter på sociala medier?",
                        application: "Fråga två kompisar vad de åt till lunch igår och se om svaren stämmer."
                    }
                ]
            },
            {
                id: 2, title: "Block 2: Ekonomi", icon: "zap", sections: [
                    {
                        title: "A: Pengar förr & nu", page: "43–44",
                        text: "Byteshandel har funnits länge men det är krångligt att byta en ko mot rätt mängd säd varje gång man ska handla. För några tusen år sedan uppfanns pengar för att mäta värde. I Sverige var de första mynten av metall och värda sin vikt. Men på 1600-talet blev det brist på guld och silver. Man började då använda koppar. Eftersom koppar var billigare blev mynten enormt tunga. De tyngsta vägde över 19 kilo! År 1660 öppnade Johan Palmstruch den första banken i Stockholm. Han tog emot de tunga mynten och gav ut kvitton på papper. Dessa blev Sveriges första sedlar. Idag är de flesta pengar elektroniska siffror på ett konto.",
                        concepts: ["Byteshandel", "Metallen", "Sedlar", "Kontanter", "Digitala pengar"],
                        mustKnow: ["Varför pengar uppfanns.", "Svenska kopparmynt vägde upp till 19 kilo.", "Vem som startade den första banken."],
                        summary: ["Pengar förenklar handel.", "Förr var myntens värde kopplat till metallens vikt.", "De första sedlarna var kvitton från en bank."],
                        test: [{q: "Vad kallas direkt byte av varor?", a: "Byteshandel"}, {q: "Hur mycket vägde de tyngsta mynten?", a: "Över 19 kg"}, {q: "Vem startade första banken?", a: "Johan Palmstruch"}],
                        reasoning: "Vilka problem skulle uppstå om vi tvingades gå tillbaka till byteshandel?",
                        application: "Designa ett eget mynt och förklara vad det ska vara värt."
                    },
                    {
                        title: "B: Brutto, Netto & Skatt", page: "46–47",
                        text: "När en person arbetar får hen lön. Men man får inte behålla alla pengar. Bruttolön är lönen innan skatten är dragen. I Sverige betalar vi inkomstskatt till staten och kommunen. Skatten är ofta cirka 30 procent. Det som blir kvar kallas nettolön. Det är nettolönen som kommer in på bankkontot och används till mat och hyra. Skattepengarna betalar för den offentliga sektorn. Det är saker vi äger tillsammans. Det betalar för skolor, lärare, sjukhus och poliser. Det betalar också för vägar och domstolar. Utöver lön kan man få bidrag, som barnbidrag som föräldrar får varje månad.",
                        concepts: ["Bruttolön", "Nettolön", "Skatt", "Offentlig sektor", "Bidrag"],
                        mustKnow: ["Brutto är före skatt, Netto är efter skatt.", "Skatten i Sverige är ca 30%.", "Vad skattepengarna används till."],
                        summary: ["Bruttolön är lönen innan skatten dras.", "Nettolön är pengarna man får ut.", "Skatten betalar skola, vård och poliser."],
                        test: [{q: "Vad kallas lönen före skatt?", a: "Bruttolön"}, {q: "Vad kallas lönen efter skatt?", a: "Nettolön"}, {q: "Ungefär hur mycket är skatten?", a: "Cirka 30%"}],
                        reasoning: "Vad skulle hända med skolorna om ingen ville betala inkomstskatt?",
                        application: "Räkna ut nettolönen om bruttolönen är 100 kr och skatten är 30 kr."
                    }
                ]
            },
            {
                id: 3, title: "Block 3: Banker & Priser", icon: "landmark", sections: [
                    {
                        title: "A: Banken som mellanhand", page: "52",
                        text: "Banker är livsviktiga i vår ekonomi. De fungerar som en mellanhand mellan sparare och lånare. Pengarna i en bank kommer från människor och företag som sparar sina pengar där. När du sätter in pengar lånar du egentligen ut dem till banken. Banken samlar ihop pengar från många sparare till en stor summa. Denna stora summa kan banken sedan låna ut till andra. Det kan vara en familj som vill köpa ett hus eller ett företag som vill bygga en ny fabrik. Banken granskar noga de som vill låna för att vara säkra på att de kan betala tillbaka.",
                        concepts: ["Mellanhand", "Sparande", "Låntagare", "Bank"],
                        mustKnow: ["Bankens roll som förmedlare.", "Att sparade pengar används till utlåning.", "Varför banken kontrollerar lånare."],
                        summary: ["Banken kopplar ihop sparare med lånare.", "När du sparar lånar du ut till banken.", "Banken lånar ut pengar till hus och företag."],
                        test: [{q: "Vad är bankens främsta roll?", a: "Mellanhand för pengar"}, {q: "Varifrån får banken pengar?", a: "Från folk som sparar"}],
                        reasoning: "Varför tror du att banken är så viktig för att ett land ska vara rikt?",
                        application: "Förklara för en kompis varför hens sparade pengar hjälper nån annan att bygga hus."
                    },
                    {
                        title: "B: Ränta & Riksbanken", page: "52–53",
                        text: "Ränta är priset på pengar. Inlåningsränta är den ersättning du får när du sparar i banken. Utlåningsränta är istället den avgift du betalar till banken när du lånar. Utlåningsräntan är alltid högre än inlåningsräntan. Skillnaden kallas räntegapet – det är bankens vinst. I Sverige finns Riksbanken, statens bank, vars viktigaste uppgift är att se till att våra pengar behåller sitt värde genom att motverka inflation. Riksbanken styr styrräntan.",
                        concepts: ["Ränta", "Inlåning", "Utlåning", "Räntegap", "Riksbanken"],
                        mustKnow: ["Skillnad på in- och utlåningsränta.", "Räntegapet är vinsten.", "Riksbankens roll."],
                        summary: ["Ränta är priset för pengar.", "Banken tar mer betalt för lån än den ger för sparande.", "Riksbanken styr styrräntan."],
                        test: [{q: "Vad är ränta?", a: "Priset på pengar"}, {q: "Vad är räntegapet?", a: "Skillnaden mellan räntorna"}],
                        reasoning: "Hur påverkas en familj om räntan stiger kraftigt?",
                        application: "Räkna ut räntegapet om banken ger 2% och tar 6%."
                    }
                ]
            },
            {
                id: 4, title: "Block 4: Lag & Rätt", icon: "scale", sections: [
                    {
                        title: "A: Rättskedjan", page: "62–63",
                        text: "När ett brott har begåtts startar rättskedjan. Det börjar med polisen som utreder vad som hänt och säkrar bevis. Om polisen tror att de hittat den skyldige tar åklagaren över. Åklagaren beslutar om bevisen räcker för en rättegång. Själva rättegången sker i en domstol, tingsrätten. Där sitter en domare och tre nämndemän (vanliga människor). Om personen döms får hen en påföljd (straff), som böter eller fängelse.",
                        concepts: ["Åklagare", "Nämndeman", "Påföljd", "Tingsrätt"],
                        mustKnow: ["Stegen i rättskedjan.", "Vad en nämndeman är.", "Att påföljd betyder straff."],
                        summary: ["Polisen utreder och samlar bevis.", "Åklagaren beslutar om åtal.", "Tingsrätten dömer."],
                        test: [{q: "Vad är polisens första uppgift?", a: "Utreda och samla bevis"}, {q: "Vem beslutar om rättegång?", a: "Åklagaren"}],
                        reasoning: "Varför tror du att vi har nämndemän i Sverige?",
                        application: "Rita en tidslinje över rättskedjans steg."
                    }
                ]
            },
            {
                id: 5, title: "Block 5: Demokrati", icon: "users", sections: [
                    {
                        title: "A: Vad är demokrati?", page: "75",
                        text: "Ordet demokrati kommer från grekiskan och betyder folkstyre. I Sverige har vi representativ demokrati. Vi väljer representanter (politiker) som vi litar på till riksdag, region och kommun. Dessa fattar sedan besluten åt oss. Det finns också direkt demokrati, t.ex. när vi har en folkomröstning eller röstar genom handuppräckning i klassrummet.",
                        concepts: ["Folkstyre", "Representativ", "Direkt demokrati"],
                        mustKnow: ["Vad ordet demokrati betyder.", "Skillnaden på direkt och representativ demokrati."],
                        summary: ["Demokrati betyder att folket bestämmer.", "Vi väljer politiker som fattar besluten.", "Aten var först med demokrati."],
                        test: [{q: "Från vilket språk kommer ordet?", a: "Grekiskan"}, {q: "Vad betyder folkstyre?", a: "Demokrati"}],
                        reasoning: "Varför röstar vi inte om allt i mobilen varje dag?",
                        application: "Ge ett exempel på direkt demokrati i skolan."
                    },
                    {
                        title: "B: Spelregler", page: "76–77",
                        text: "En demokrati kräver spelregler: 1. Fria och hemliga val (ingen ser vad du röstar). 2. Yttrandefrihet och tryckfrihet (du får tycka och skriva vad du vill). 3. Rättssäkerhet (alla är lika inför lagen). 4. Majoritetsprincipen (det förslag med flest röster vinner, men minoriteter måste skyddas).",
                        concepts: ["Hemliga val", "Yttrandefrihet", "Rättssäkerhet"],
                        mustKnow: ["De fyra grundpelarna.", "Varför valen ska vara hemliga."],
                        summary: ["Valen måste vara fria och hemliga.", "Yttrandefrihet är en mänsklig rättighet.", "Lagen gäller lika för alla."],
                        test: [{q: "Måste man berätta vad man röstat på?", a: "Nej"}, {q: "Vem bestämmer i en röstning?", a: "Majoriteten"}],
                        reasoning: "Vad händer om valen inte vore hemliga?",
                        application: "Gör en checklista för att se om ett land är en demokrati."
                    }
                ]
            },
            {
                id: 6, title: "Block 6: Riksdag & Regering", icon: "landmark", sections: [
                    {
                        title: "A: Riksdagen", page: "84–85",
                        text: "Riksdagen har 349 ledamöter valda av folket vart fjärde år. Riksdagens två viktigaste uppgifter är att stifta lagar och besluta om statens budget. Budgeten är en plan för hur skattepengarna ska användas (t.ex. till skola, polis, försvar). Riksdagen kontrollerar också regeringen.",
                        concepts: ["Ledamot", "Budget", "Majoritet", "Stifta lagar"],
                        mustKnow: ["Riksdagen har 349 ledamöter.", "Riksdagens roll att stifta lagar.", "Vikten av statens budget."],
                        summary: ["Riksdagen representerar folket.", "De stiftar lagar och bestämmer om pengarna.", "Majoriteten i riksdagen avgör röstningar."],
                        test: [{q: "Hur många sitter i riksdagen?", a: "349 stycken"}, {q: "Vem väljer ledamöterna?", a: "Folket"}],
                        reasoning: "Varför är det viktigt att riksdagen bestämmer över pengarna?",
                        application: "Namnge ett parti som sitter i riksdagen."
                    }
                ]
            },
            {
                id: 7, title: "Block 7: Framtiden", icon: "briefcase", sections: [
                    {
                        title: "A: Jobben & AI", page: "29–34",
                        text: "Arbetsmarknaden ändras snabbt. Förr jobbade nästan alla med jordbruk, idag med tjänster. Robotar tar över tunga jobb i fabriker. AI (artificiell intelligens) är datorprogram som kan lära sig saker. AI används redan i vården för att ställa diagnoser. Yrken som kräver empati och mänsklig kontakt (lärare, frisör) kommer alltid behöva människor.",
                        concepts: ["Digitalisering", "AI", "Globalisering"],
                        mustKnow: ["Teknikens påverkan på jobb.", "AI i vården.", "Att tjänstesamhället växer."],
                        summary: ["Robotar tar tunga jobb.", "AI är smarta datorer som lär sig.", "Vissa yrken kan inte ersättas av robotar."],
                        test: [{q: "Vad står AI för?", a: "Artificiell intelligens"}, {q: "Vilka jobb försvinner?", a: "Tunga/enformiga"}],
                        reasoning: "Kommer en robot kunna vara din lärare i framtiden?",
                        application: "Intervjua en vuxen om hur tekniken ändrat deras jobb."
                    }
                ]
            }
        ];

        function App() {
            const [activeBlock, setActiveBlock] = useState(0);
            const [activeSection, setActiveSection] = useState(0);
            const [aiChat, setAiChat] = useState([]);
            const [isLoading, setIsLoading] = useState(false);
            const [splitPercent, setSplitPercent] = useState(60);
            const [isTeacherMode, setIsTeacherMode] = useState(false);
            const [history, setHistory] = useState([]);
            const [showDetail, setShowDetail] = useState(null);

            const splitRef = useRef(null);
            const isDragging = useRef(false);

            const block = BLOCKS[activeBlock];
            const section = block.sections[activeSection];

            // Split View Logic
            const onStartDragging = () => { isDragging.current = true; document.body.style.cursor = 'ns-resize'; };
            const onEndDragging = () => { isDragging.current = false; document.body.style.cursor = 'default'; };
            const onDragging = (e) => {
                if (!isDragging.current) return;
                const rect = splitRef.current.getBoundingClientRect();
                const y = (e.clientY || e.touches?.[0].clientY) - rect.top;
                let p = (y / rect.height) * 100;
                if (p < 15) p = 15; if (p > 85) p = 85;
                setSplitPercent(p);
            };

            const askAI = async (type, queryText = "") => {
                setIsLoading(true);
                const userMsg = { role: 'user', content: queryText || `Hjälp med: ${type}` };
                setAiChat(prev => [...prev, userMsg]);

                const sysPrompt = `Du är Studiekompisen AI för årskurs 6. DIN TEXTBANK: "${section.text}" (Sida ${section.page}). REGLER: 1) Endast fakta från textbanken. 2) Inga externa fakta. 3) Resonemang: coacha med frågor. 4) Avsluta alltid med "Källa: sida ${section.page}".`;
                let q = queryText || (type === 'simplify' ? "Förklara texten enklare men behåll fakta." : "Ge ett vardagligt exempel.");

                try {
                    const res = await fetch(`/.netlify/functions/gemini`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ q, systemPrompt: sysPrompt, model: "gemini-2.5-flash" })
                    });
                    const data = await res.json();
                    const aiResponse = data.candidates?.[0]?.content?.parts?.[0]?.text || "Kunde inte hämta svar.";
                    setAiChat(prev => [...prev, { role: 'ai', content: aiResponse }]);
                    setHistory(prev => [...prev, { s: section.page, q: q, a: aiResponse }]);
                } catch (err) {
                    setAiChat(prev => [...prev, { role: 'ai', content: "Anslutningsfel. Kontrollera Netlify-funktionen." }]);
                } finally {
                    setIsLoading(false);
                }
            };

            return (
                <div className="flex w-full h-full text-left" onMouseMove={onDragging} onMouseUp={onEndDragging} onTouchMove={onDragging} onTouchEnd={onEndDragging}>
                    {/* SIDEBAR */}
                    <aside className="w-80 bg-white border-r flex flex-col shrink-0 z-50">
                        <div className="p-8 bg-indigo-700 text-white">
                            <div className="flex items-center gap-3">
                                <span className="bg-white p-2 rounded-lg text-indigo-700">
                                    <i data-lucide="graduation-cap"></i>
                                </span>
                                <h1 className="text-xl font-black uppercase italic leading-none">Studiekompisen</h1>
                            </div>
                            <p className="text-[10px] mt-2 opacity-70 uppercase font-bold tracking-widest text-left">SO-STÖD ÅK 6</p>
                        </div>
                        <nav className="flex-1 p-4 overflow-y-auto custom-scrollbar space-y-1">
                            {BLOCKS.map((b, i) => (
                                <button key={i} onClick={() => { setActiveBlock(i); setActiveSection(0); setAiChat([]); }}
                                    className={`w-full flex items-center gap-3 p-4 rounded-2xl transition-all font-bold text-xs ${activeBlock === i ? 'bg-indigo-50 text-indigo-700' : 'text-slate-500 hover:bg-slate-50'}`}>
                                    <span className="p-2 bg-slate-100 rounded-lg"><i data-lucide={b.icon} className="w-4 h-4"></i></span>
                                    {b.title}
                                </button>
                            ))}
                        </nav>
                        <div className="p-4 border-t">
                            <button onClick={() => setIsTeacherMode(!isTeacherMode)} className="w-full p-3 rounded-xl bg-slate-50 text-slate-400 text-[10px] font-black uppercase tracking-widest flex justify-between items-center">
                                Lärarlogg <i data-lucide={isTeacherMode ? "eye" : "eye-off"} className="w-3 h-3"></i>
                            </button>
                        </div>
                    </aside>

                    {/* MAIN CONTENT AREA */}
                    <main className="flex-1 flex flex-col relative bg-white overflow-hidden" ref={splitRef}>
                        <header className="bg-white/90 border-b p-4 flex items-center justify-between z-10 shrink-0">
                            <div className="flex gap-2 overflow-x-auto no-scrollbar">
                                {block.sections.map((s, i) => (
                                    <button key={i} onClick={() => { setActiveSection(i); setAiChat([]); setShowDetail(null); }}
                                        className={`px-4 py-2 rounded-full text-[10px] font-black uppercase tracking-widest ${activeSection === i ? 'bg-indigo-600 text-white' : 'bg-slate-100 text-slate-400 hover:bg-slate-200'}`}>
                                        {s.title}
                                    </button>
                                ))}
                            </div>
                            <div className="bg-indigo-50 text-indigo-600 px-4 py-1.5 rounded-full text-[10px] font-black uppercase whitespace-nowrap border border-indigo-100">
                                Sida {section.page}
                            </div>
                        </header>

                        <div className="split-container">
                            <div className="panel-text panel-text custom-scrollbar" style={{ flexBasis: `${splitPercent}%` }}>
                                <div className="max-w-4xl mx-auto p-8 space-y-12">
                                    <section className="bg-amber-50 p-10 rounded-[3rem] border-4 border-amber-100 shadow-xl relative overflow-hidden">
                                        <h4 className="text-[10px] font-black text-amber-700 uppercase tracking-widest mb-6 flex items-center gap-2 italic">
                                            <i data-lucide="check-circle-2" className="w-4 h-4"></i> Detta behöver du kunna
                                        </h4>
                                        <ul className="space-y-3">
                                            {section.mustKnow.map((m, i) => <li key={i} className="flex gap-4 font-bold text-amber-900 leading-snug"><span className="text-amber-400">▶</span> {m}</li>)}
                                        </ul>
                                    </section>

                                    <section className="bg-white p-12 rounded-[4rem] shadow-2xl border border-slate-100 relative overflow-hidden animate-fade-in text-left">
                                        <div className="absolute top-0 left-0 w-2 h-full bg-indigo-600"></div>
                                        <p className="text-2xl leading-[1.8] text-slate-700 font-bold whitespace-pre-wrap">{section.text}</p>
                                        <div className="mt-14 pt-10 border-t-2 border-slate-50">
                                            <p className="text-[10px] font-black text-slate-400 uppercase mb-5">Begrepp (klicka för förklaring):</p>
                                            <div className="flex flex-wrap gap-2">
                                                {section.concepts.map((c, i) => <button key={i} onClick={() => askAI('concept', c)} className="px-5 py-2.5 bg-indigo-50 text-indigo-700 rounded-2xl text-[10px] font-black uppercase tracking-widest hover:bg-indigo-600 hover:text-white transition-all shadow-sm border border-indigo-100">{c}</button>)}
                                            </div>
                                        </div>
                                    </section>

                                    <section className="grid grid-cols-1 md:grid-cols-3 gap-6 font-black uppercase text-[10px] tracking-widest">
                                        <button onClick={() => setShowDetail('summary')} className="p-10 rounded-[2.5rem] border-4 border-slate-100 bg-white text-slate-400 flex flex-col items-center gap-4 hover:border-indigo-200 transition-all"><i data-lucide="list-checks" className="w-10 h-10"></i> Sammanfattning</button>
                                        <button onClick={() => setShowDetail('test')} className="p-10 rounded-[2.5rem] border-4 border-slate-100 bg-white text-slate-400 flex flex-col items-center gap-4 hover:border-blue-200 transition-all"><i data-lucide="zap" className="w-10 h-10"></i> Självtest</button>
                                        <button onClick={() => setShowDetail('reasoning')} className="p-10 rounded-[2.5rem] border-4 border-slate-100 bg-white text-slate-400 flex flex-col items-center gap-4 hover:border-emerald-200 transition-all"><i data-lucide="brain-circuit" className="w-10 h-10"></i> Resonera</button>
                                    </section>

                                    {showDetail && (
                                        <div className="bg-slate-50 p-12 rounded-[3.5rem] border-2 border-slate-100 animate-fade-in text-left">
                                            {showDetail === 'summary' && <ul className="space-y-4">{section.summary.map((s, i) => <li key={i} className="bg-white p-7 rounded-3xl font-bold flex gap-5 shadow-sm leading-tight border border-slate-100"><span className="text-indigo-500 font-black">0{i+1}</span>{s}</li>)}</ul>}
                                            {showDetail === 'test' && <div className="grid grid-cols-1 md:grid-cols-2 gap-4">{section.test.map((t, i) => <div key={i} className="bg-white p-6 rounded-3xl border border-blue-50 shadow-sm flex flex-col justify-between italic text-sm font-black text-slate-800">"{t.q}"<button onClick={(e) => { e.currentTarget.innerHTML = `<span class='text-blue-600'>${t.a}</span>`; }} className="text-[9px] text-blue-300 uppercase mt-4 text-left">Visa svar</button></div>)}</div>}
                                            {showDetail === 'reasoning' && <div className="bg-white p-12 rounded-[3rem] italic font-black text-2xl text-slate-700 text-center leading-relaxed">"{section.reasoning}"<button onClick={() => askAI('develop')} className="bg-emerald-600 text-white px-10 py-4 rounded-full text-xs font-black mt-10 uppercase tracking-widest block mx-auto text-center shadow-lg">Hjälp mig tänka vidare</button></div>}
                                        </div>
                                    )}

                                    <section className="bg-slate-900 text-white p-12 rounded-[4rem] shadow-2xl relative overflow-hidden group text-left">
                                        <h4 className="text-[10px] font-black text-indigo-400 uppercase tracking-widest mb-6 italic">Tillämpning: Gör detta nu</h4>
                                        <p className="text-2xl font-bold leading-snug tracking-tight">{section.application}</p>
                                    </section>
                                </div>
                            </div>

                            <div className="drag-handle" onMouseDown={onStartDragging} onTouchStart={onStartDragging}></div>

                            <div className="panel-ai panel-ai custom-scrollbar p-8">
                                <div className="max-w-4xl mx-auto w-full space-y-6">
                                    <div className="flex gap-3 overflow-x-auto no-scrollbar pb-1 text-left">
                                        <button onClick={() => askAI('simplify')} className="bg-indigo-600 text-white px-6 py-4 rounded-2xl text-[10px] font-black uppercase tracking-widest flex items-center gap-3 shadow-lg"><i data-lucide="sparkles" className="w-4 h-4"></i> Förklara enklare</button>
                                        <button onClick={() => askAI('example')} className="bg-slate-900 text-white px-6 py-4 rounded-2xl text-[10px] font-black uppercase tracking-widest flex items-center gap-3 shadow-lg text-left"><i data-lucide="message-square" className="w-4 h-4"></i> Ge exempel</button>
                                    </div>

                                    {aiChat.map((m, i) => (
                                        <div key={i} className={`flex ${m.role === 'user' ? 'justify-end' : 'justify-start'} animate-fade-in`}>
                                            <div className={`max-w-[85%] p-7 rounded-[2rem] text-sm font-bold shadow-xl leading-relaxed ${m.role === 'user' ? 'bg-indigo-600 text-white rounded-tr-none text-right' : 'bg-white border-2 border-slate-50 text-slate-800 rounded-tl-none text-left'}`}>
                                                {m.role === 'ai' && <div className="text-[9px] uppercase tracking-widest text-indigo-500 mb-3 font-black opacity-60 text-left">Studiekompisen AI</div>}
                                                {m.content}
                                            </div>
                                        </div>
                                    ))}
                                    {isLoading && <div className="flex justify-start text-left"><div className="bg-white p-6 rounded-[2rem] flex items-center gap-5 shadow-xl text-left"><div className="w-6 h-6 border-2 border-indigo-600 border-t-transparent rounded-full animate-spin"></div><span className="text-[10px] font-black text-indigo-400 uppercase animate-pulse italic">Studerar boken...</span></div></div>}
                                </div>
                            </div>
                        </div>
                    </main>

                    {/* TEACHER DASHBOARD */}
                    {isTeacherMode && (
                        <div className="fixed inset-0 bg-slate-900/80 backdrop-blur-2xl z-[100] flex items-center justify-center p-10">
                            <div className="bg-white w-full max-w-6xl h-[90vh] rounded-[5rem] flex flex-col overflow-hidden border-4 border-white shadow-2xl">
                                <header className="p-14 border-b flex justify-between items-center bg-slate-50/50">
                                    <h2 className="text-4xl font-black uppercase italic text-slate-900 leading-none">Kontrollpanel</h2>
                                    <button onClick={() => setIsTeacherMode(false)} className="bg-white p-5 rounded-full border-2 border-slate-100 hover:text-red-500 transition-all shadow-sm text-left"><i data-lucide="x"></i></button>
                                </header>
                                <div className="flex-1 overflow-y-auto p-14 custom-scrollbar text-left text-left">
                                    <table className="w-full text-left">
                                        <thead className="bg-slate-50 text-[11px] font-black text-slate-500 uppercase italic border-b-4 border-white"><tr><th className="p-10">Sida</th><th className="p-10">Elevens Input</th><th className="p-10">AI-svar</th></tr></thead>
                                        <tbody className="text-base font-bold text-slate-600 divide-y-4 divide-slate-50 text-left">
                                            {history.map((h, i) => (
                                                <tr key={i} className="hover:bg-indigo-50/30 transition-colors">
                                                    <td className="p-10 text-xs font-black italic whitespace-nowrap">SIDA {h.s}</td>
                                                    <td className="p-10 italic text-slate-900 text-lg">"{h.q}"</td>
                                                    <td className="p-10 text-sm font-medium opacity-60 leading-relaxed max-w-lg">{h.a}</td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);

        // Init Lucide icons after mount
        setTimeout(() => { if (window.lucide) window.lucide.createIcons(); }, 100);
    </script>
</body>
</html>
