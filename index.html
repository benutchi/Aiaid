<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Studiekompisen SH - Åk 6 (Stabil)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- React & Babel via CDN - Utvecklingsversioner för maximal stabilitet -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; margin: 0; padding: 0; }
        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 20px; border: 4px solid transparent; background-clip: content-box; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        #root { height: 100vh; display: flex; overflow: hidden; }
        .split-container { display: flex; flex-direction: column; height: 100%; width: 100%; overflow: hidden; }
.panel-text { flex: 0 0 55%; min-height: 0; overflow-y: auto; position: relative; background: white; }        .drag-handle { 
            height: 12px; background: #f8fafc; cursor: ns-resize; 
            display: flex; align-items: center; justify-content: center;
            border-top: 1px solid #e2e8f0; border-bottom: 1px solid #e2e8f0;
            flex-shrink: 0; z-index: 40; touch-action: none;
        }
        .drag-handle::after { content: ""; width: 48px; height: 4px; background: #cbd5e1; border-radius: 2px; }
        .panel-ai { flex: 1; min-height: 100px; overflow-y: auto; background: #fafafa; display: flex; flex-direction: column; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
        .sidebar-transition { transition: width 0.3s ease-in-out, opacity 0.2s ease-in-out; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900">
    <div id="root"></div>
<script src="./blocks-data.js"></script>
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const BLOCKS = window.BLOCKS_DATA;
        function App() {
            const [activeBlock, setActiveBlock] = useState(0);
            const [activeSection, setActiveSection] = useState(0);
            const [aiChat, setAiChat] = useState([]);
            const [isLoading, setIsLoading] = useState(false);
            const [splitPercent, setSplitPercent] = useState(55);
            const AI_OPEN_PERCENT = 3;  // AI går upp så högt som möjligt
const AI_DOCK_PERCENT = 85; // AI ligger kvar så knappar syns
            const [isTeacherMode, setIsTeacherMode] = useState(false);
            const [isSidebarOpen, setIsSidebarOpen] = useState(true);
            const [history, setHistory] = useState([]);
            const [showDetail, setShowDetail] = useState(null);

            const splitRef = useRef(null);
const isDragging = useRef(false);

useEffect(() => {
  const stopDragging = () => {
    isDragging.current = false;
  };

  window.addEventListener("mouseup", stopDragging);
  return () => window.removeEventListener("mouseup", stopDragging);
}, []);
            const block = BLOCKS[activeBlock] || BLOCKS[0];
            const section = block.sections[activeSection] || block.sections[0];

            // --- FIX: Robust ikon-rendering med try/catch ---
            useEffect(() => {
                if (!window.lucide?.createIcons) return;
                try {
                    window.lucide.createIcons();
                } catch (e) {
                    console.warn("Lucide fail:", e);
                }
            }, [aiChat, isSidebarOpen, isTeacherMode, showDetail, activeBlock, activeSection]);

            const askAI = async (type, queryText = "") => {
                if (isLoading) return;
                setSplitPercent(AI_OPEN_PERCENT);
                const userMsgText = queryText || (type === 'simplify' ? 'Förenkla texten' : type === 'deepen' ? 'Fördjupa' : 'Ge exempel');
                const userMsgId = Date.now();
                
                // --- FIX: Visa elevens fråga direkt för feedback ---
                setAiChat(prev => [{ id: userMsgId, role: 'user', content: userMsgText }, ...prev]);
                setIsLoading(true);

                // --- FIX: Kapa textbanken för att aldrig skicka för mycket ---
                const TEXTBANK = (section.text || "").slice(0, 8000); 

                let sysPrompt = "";
                let q = "";

                if (type === 'simplify') {
                    sysPrompt = `Du är Studiekompisen AI. Förenkla språket extremt mycket. REGLER: 1) KORTA stycken. 2) PUNKTLYSTOR. 3) Enkel svenska. Källa: sida ${section.page}. TEXTBANK: "${TEXTBANK}"`;
                    q = "Gör texten jättelätt att förstå.";
                } else if (type === 'deepen' || type === 'develop') {
                    sysPrompt = `Du är Studiekompisen AI. Fördjupa förståelsen. REGLER: 1) Fokusera på SAMBAND. 2) KONSEKVENSER. 3) Ställ en utmanande följdfråga. Källa: sida ${section.page}. TEXTBANK: "${TEXTBANK}"`;
                    q = "Hjälp mig fördjupa mig i sambanden i texten.";
                } else if (type === 'concept') {
                    sysPrompt = `Du är Studiekompisen AI. Förklara begreppet på enkel svenska utifrån texten. Källa: sida ${section.page}. TEXTBANK: "${TEXTBANK}"`;
                    q = `Förklara begreppet "${queryText}".`;
                } else {
                    sysPrompt = `Du är Studiekompisen AI. Coacha med frågor. Källa: sida ${section.page}. TEXTBANK: "${TEXTBANK}"`;
                    q = queryText || "Ge ett vardagligt exempel.";
                }

                try {
                    // --- FIX: Ingen 'model' i JSON för att inte krocka med backend ---
                    const res = await fetch(`/.netlify/functions/gemini`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ q, systemPrompt: sysPrompt })
                    });
                    
                    if (!res.ok) {
                        const errBody = await res.text();
                        throw new Error(`Serverfel (HTTP ${res.status}): ${errBody.substring(0, 100)}`);
                    }
                    
                    const data = await res.json();
                    const aiResponse = data.candidates?.[0]?.content?.parts?.[0]?.text || "AI gav inget svar.";
                    
                    setAiChat(prev => [{ id: Date.now(), role: 'ai', content: aiResponse, query: userMsgText }, ...prev]);
                    setHistory(prev => [{ s: section.page, q: userMsgText, a: aiResponse }, ...prev]);
                } catch (err) {
                    setAiChat(prev => [{ id: Date.now(), role: 'error', content: `Hoppsan! Kunde inte hämta svar (${err.message}).` }, ...prev]);
                } finally {
                    setIsLoading(false);
                }
            };

            const removeMsg = (id) => setAiChat(prev => prev.filter(m => m.id !== id));

            return (
                <div className="flex w-full h-full text-left" 
                    onMouseMove={(e) => {
                        if (!isDragging.current) return;
                        const rect = splitRef.current.getBoundingClientRect();
                        const y = e.clientY - rect.top;
                        let p = (y / rect.height) * 100;
setSplitPercent(Math.max(3, Math.min(97, p)));                    }}
                    onMouseUp={() => isDragging.current = false}
                >
                    <aside className={`bg-white border-r flex flex-col shrink-0 z-50 sidebar-transition ${isSidebarOpen ? 'w-80 opacity-100' : 'w-0 opacity-0 overflow-hidden'}`}>
                        <div className="p-8 bg-indigo-700 text-white flex flex-col items-start">
                            <div className="flex items-center gap-3">
                                <span className="bg-white p-2 rounded-lg text-indigo-700"><i data-lucide="graduation-cap"></i></span>
                                <h1 className="text-xl font-black uppercase italic leading-none">Studiekompisen</h1>
                            </div>
                            <p className="text-[10px] mt-2 opacity-70 uppercase font-bold tracking-widest text-left">Utkik SO Åk 6</p>
                        </div>
                        <nav className="flex-1 p-4 overflow-y-auto custom-scrollbar space-y-1">
                            {BLOCKS.map((b, i) => (
                                <button key={i} onClick={() => { setActiveBlock(i); setActiveSection(0); setAiChat([]); setShowDetail(null); }}
                                    className={`w-full flex items-center gap-3 p-4 rounded-2xl transition-all font-bold text-xs ${activeBlock === i ? 'bg-indigo-50 text-indigo-700 ring-2 ring-indigo-100' : 'text-slate-500 hover:bg-slate-50'} text-left`}>
                                    <span className="p-2 bg-slate-100 rounded-lg"><i data-lucide={b.icon || "circle"}></i></span>
                                    <span className="whitespace-nowrap leading-tight">{b.title}</span>
                                </button>
                            ))}
                        </nav>
                        <div className="p-4 border-t text-left text-left">
                            <button onClick={() => setIsTeacherMode(!isTeacherMode)} className="w-full p-3 rounded-xl bg-slate-50 text-slate-400 text-[10px] font-black uppercase tracking-widest flex justify-between items-center text-left">
                                Lärarlogg <i data-lucide={isTeacherMode ? "eye" : "eye-off"}></i>
                            </button>
                        </div>
                    </aside>

                    <main className="flex-1 flex flex-col relative bg-white overflow-hidden text-left" ref={splitRef}>
                        <header className="bg-white/90 border-b p-4 flex items-center justify-between z-10 shrink-0 text-left text-left">
                            <div className="flex items-center gap-4 overflow-hidden text-left text-left">
                                <button onClick={() => setIsSidebarOpen(!isSidebarOpen)} className="p-2 bg-slate-100 hover:bg-slate-200 rounded-lg text-slate-600 shrink-0"><i data-lucide={isSidebarOpen ? "panel-left-close" : "panel-left-open"}></i></button>
                                <div className="flex gap-2 overflow-x-auto no-scrollbar text-left">
                                    {block.sections.map((s, i) => (
                                        <button key={i} onClick={() => { setActiveSection(i); setAiChat([]); setShowDetail(null); }}
                                            className={`px-4 py-2 rounded-full text-[10px] font-black uppercase tracking-widest whitespace-nowrap transition-all ${activeSection === i ? 'bg-indigo-600 text-white shadow-md' : 'bg-slate-100 text-slate-400 hover:bg-slate-200'}`}>
                                            {s.title}
                                        </button>
                                    ))}
                                </div>
                            </div>
                            <div className="bg-indigo-50 text-indigo-600 px-4 py-1.5 rounded-full text-[10px] font-black uppercase border border-indigo-100 ml-2">Sida {section.page}</div>
                        </header>

                        <div className="split-container text-left text-left">
                            <div className="panel-text custom-scrollbar text-left text-left" style={{ flexBasis: `${splitPercent}%` }}>
                                <div className="max-w-4xl mx-auto p-8 space-y-12 pb-20 text-left text-left">
                                    <section className="bg-amber-50 p-10 rounded-[3rem] border-4 border-amber-100 shadow-xl relative overflow-hidden text-left text-left">
                                        <h4 className="text-[10px] font-black text-amber-700 uppercase tracking-widest mb-6 flex items-center gap-2 italic text-left text-left"><i data-lucide="check-circle-2"></i> Detta behöver du kunna</h4>
                                        <ul className="space-y-3 text-left">{(section.mustKnow || []).map((m, i) => <li key={i} className="flex gap-4 font-bold text-amber-900 leading-snug text-left"><span className="text-amber-400 font-black">▶</span> {m}</li>)}</ul>
                                    </section>

                                    <section className="bg-white p-12 rounded-[4rem] shadow-2xl border border-slate-100 relative animate-fade-in text-left text-left">
                                        <div className="absolute top-0 left-0 w-2 h-full bg-indigo-600 text-left text-left"></div>
                                        <p className="text-2xl leading-[1.8] text-slate-700 font-bold whitespace-pre-wrap text-left text-left">{section.text}</p>
                                        <div className="mt-14 pt-10 border-t-2 border-slate-50 text-left text-left text-left">
                                            <p className="text-[10px] font-black text-slate-400 uppercase mb-5">Begrepp (klicka för förklaring):</p>
                                            <div className="flex flex-wrap gap-2 text-left">{(section.concepts || []).map((c, i) => <button key={i} onClick={() => askAI('concept', c)} className="px-5 py-2.5 bg-indigo-50 text-indigo-700 rounded-2xl text-[10px] font-black uppercase tracking-widest hover:bg-indigo-600 hover:text-white transition-all border border-indigo-100 text-left">{c}</button>)}</div>
                                        </div>
                                    </section>

                                    <section className="grid grid-cols-1 md:grid-cols-3 gap-6 font-black uppercase text-[10px] tracking-widest text-left text-left">
                                        <button onClick={() => setShowDetail(showDetail === 'summary' ? null : 'summary')} className={`p-10 rounded-[2.5rem] border-4 transition-all flex flex-col items-center gap-4 ${showDetail === 'summary' ? 'bg-indigo-600 border-indigo-400 text-white' : 'bg-white border-slate-100 text-slate-400'}`}><i data-lucide="list-checks"></i> Sammanfattning</button>
                                        <button onClick={() => setShowDetail(showDetail === 'test' ? null : 'test')} className={`p-10 rounded-[2.5rem] border-4 transition-all flex flex-col items-center gap-4 ${showDetail === 'test' ? 'bg-blue-600 border-blue-400 text-white' : 'bg-white border-slate-100 text-slate-400'}`}><i data-lucide="zap"></i> Självtest</button>
                                        <button onClick={() => setShowDetail(showDetail === 'reasoning' ? null : 'reasoning')} className={`p-10 rounded-[2.5rem] border-4 transition-all flex flex-col items-center gap-4 ${showDetail === 'reasoning' ? 'bg-emerald-600 border-emerald-400 text-white' : 'bg-white border-slate-100 text-slate-400'}`}><i data-lucide="brain-circuit"></i> Resonera</button>
                                    </section>

                                    {showDetail && (
                                        <div className="bg-slate-50 p-12 rounded-[3.5rem] border-2 border-slate-100 animate-fade-in text-left text-left text-left">
                                            {showDetail === 'summary' && <ul className="space-y-4 text-left">{(section.summary || []).map((s, i) => <li key={i} className="bg-white p-7 rounded-3xl font-bold flex gap-5 shadow-sm border border-slate-100 text-left"><span className="text-indigo-500 font-black text-left text-left">0${i+1}</span>{s}</li>)}</ul>}
                                            {showDetail === 'test' && <div className="grid grid-cols-1 md:grid-cols-2 gap-4 text-left">{(section.test || []).map((t, i) => <div key={i} className="bg-white p-6 rounded-3xl border border-blue-50 shadow-sm flex flex-col justify-between italic text-sm font-black text-slate-800 text-left">"{t.q}"<button onClick={(e) => { e.currentTarget.innerHTML = `<span class='text-blue-600 font-black'>${t.a}</span>`; }} className="text-[9px] text-blue-300 uppercase mt-4 text-left">Visa svar</button></div>)}</div>}
                                        </div>
                                    )}

                                    <section className="bg-slate-900 text-white p-12 rounded-[4rem] shadow-2xl relative overflow-hidden group text-left text-left text-left">
                                        <h4 className="text-[10px] font-black text-indigo-400 uppercase tracking-widest mb-6 italic text-left text-left text-left">Tillämpning: Gör detta nu</h4>
                                        <p className="text-2xl font-bold leading-snug tracking-tight text-left text-left">{section.application || "Läs i boken."}</p>
                                    </section>
                                </div>
                            </div>

                            <div className="drag-handle" onMouseDown={(e) => { isDragging.current = true; e.preventDefault(); }}></div>

                            <div className="panel-ai custom-scrollbar p-8 text-left text-left text-left text-left text-left">
                                <div className="max-w-4xl mx-auto w-full space-y-6 text-left text-left">
                                    <div className="flex gap-3 overflow-x-auto no-scrollbar pb-1 text-left text-left text-left text-left">
                                        <button onClick={() => askAI('simplify')} className="bg-blue-600 text-white px-6 py-4 rounded-2xl text-[10px] font-black uppercase tracking-widest flex items-center gap-3 shadow-lg shrink-0 text-left text-left"><i data-lucide="sparkles" className="w-4 h-4 text-left text-left text-left"></i> Förenkla texten</button>
                                        <button onClick={() => askAI('deepen')} className="bg-emerald-600 text-white px-6 py-4 rounded-2xl text-[10px] font-black uppercase tracking-widest flex items-center gap-3 shadow-lg shrink-0 text-left text-left text-left"><i data-lucide="brain" className="w-4 h-4 text-left text-left text-left"></i> Fördjupa & samband</button>
                                        <button onClick={() => askAI('example')} className="bg-slate-900 text-white px-6 py-4 rounded-2xl text-[10px] font-black uppercase tracking-widest flex items-center gap-3 shadow-lg shrink-0 text-left text-left text-left text-left"><i data-lucide="message-square" className="w-4 h-4 text-left text-left text-left text-left"></i> Ge exempel</button>
                                    </div>
                                    
                                    {isLoading && <div className="flex justify-start text-left text-left text-left text-left text-left text-left text-left text-left"><div className="bg-white p-6 rounded-[2rem] flex items-center gap-5 shadow-xl text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left"><div className="w-6 h-6 border-2 border-indigo-600 border-t-transparent rounded-full animate-spin text-left text-left text-left text-left"></div><span className="text-[10px] font-black text-indigo-400 uppercase animate-pulse italic text-left text-left text-left text-left text-left text-left text-left">Studerar boken...</span></div></div>}

                                    <div className="space-y-6 flex flex-col text-left text-left text-left">
                                        {aiChat.map((m) => (
                                            <div key={m.id} className="animate-fade-in group relative text-left text-left text-left">
                                                <div className={`p-7 rounded-[2rem] text-sm font-bold shadow-xl leading-relaxed ${m.role === 'error' ? 'bg-red-50 text-red-600 border-red-100' : m.role === 'user' ? 'bg-indigo-600 text-white rounded-tr-none text-right' : 'bg-white border-2 text-slate-800 border-slate-50'}`}>
                                                    <div className="flex justify-between items-start mb-3 text-left text-left text-left">
                                                        <div className={`text-[9px] uppercase tracking-widest font-black opacity-60 ${m.role === 'user' ? 'text-indigo-200' : m.role === 'error' ? 'text-red-500' : 'text-indigo-500'}`}>
                                                            {m.role === 'user' ? 'Din fråga' : m.role === 'ai' ? `Hjälp med ${m.query}` : 'Systemfel'}
                                                        </div>
                                                        <button onClick={() => removeMsg(m.id)} className="p-1 hover:bg-black/10 rounded-full text-current opacity-40 hover:opacity-100 transition-all text-left text-left text-left text-left text-left">
                                                            <i data-lucide="x" className="w-4 h-4 text-left text-left text-left text-left text-left text-left"></i>
                                                        </button>
                                                    </div>
                                                    <div className="whitespace-pre-wrap text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left">{m.content}</div>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </main>

                    {isTeacherMode && (
                        <div className="fixed inset-0 bg-slate-900/80 backdrop-blur-2xl z-[100] flex items-center justify-center p-10 text-left text-left text-left text-left text-left text-left text-left text-left text-left">
                            <div className="bg-white w-full max-w-6xl h-[90vh] rounded-[5rem] flex flex-col overflow-hidden border-4 border-white shadow-2xl text-left text-left text-left text-left text-left text-left text-left text-left text-left">
                                <header className="p-14 border-b flex justify-between items-center bg-slate-50/50 text-left text-left text-left text-left text-left text-left">
                                    <h2 className="text-4xl font-black uppercase italic text-slate-900 leading-none text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left">Kontrollpanel</h2>
                                    <button onClick={() => setIsTeacherMode(false)} className="bg-white p-5 rounded-full border-2 border-slate-100 hover:text-red-500 transition-all shadow-sm text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left"><i data-lucide="x"></i></button>
                                </header>
                                <div className="flex-1 overflow-y-auto p-14 custom-scrollbar text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left">
                                    <table className="w-full text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left">
                                        <thead className="bg-slate-50 text-[11px] font-black text-slate-500 uppercase italic border-b-4 border-white text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left"><tr><th className="p-10 text-left text-left text-left text-left text-left text-left">Sida</th><th className="p-10 text-left text-left text-left text-left text-left text-left text-left text-left">Input</th><th className="p-10 text-left text-left text-left text-left text-left text-left text-left text-left text-left">Svar</th></tr></thead>
                                        <tbody className="text-base font-bold text-slate-600 divide-y-4 divide-slate-50 text-left text-left text-left text-left text-left text-left text-left text-left text-left">
                                            {history.map((h, i) => (
                                                <tr key={i} className="hover:bg-indigo-50/30 transition-colors text-left text-left text-left text-left text-left">
                                                    <td className="p-10 text-xs font-black italic whitespace-nowrap text-left text-left text-left text-left text-left text-left">SIDA {h.s}</td>
                                                    <td className="p-10 italic text-slate-900 text-lg text-left text-left text-left text-left text-left text-left text-left text-left">"{h.q}"</td>
                                                    <td className="p-10 text-sm font-medium opacity-60 leading-relaxed max-w-lg text-left text-left text-left text-left text-left text-left text-left text-left text-left text-left">{h.a}</td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        // --- GLOBAL ERROR LISTENERS (FÖRE RENDER) ---
        window.addEventListener("error", (e) => console.log("JS ERROR:", e.error || e.message));
        window.addEventListener("unhandledrejection", (e) => console.log("PROMISE ERROR:", e.reason));

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
