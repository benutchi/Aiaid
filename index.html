<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Studiekompisen SH - Åk 6 (Fullständig Skolbok)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- React & Babel for CDN usage -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; margin: 0; padding: 0; }
        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 20px; border: 4px solid transparent; background-clip: content-box; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        #root { height: 100vh; display: flex; overflow: hidden; }
        .split-container { display: flex; flex-direction: column; height: 100%; width: 100%; overflow: hidden; }
        .panel-text { flex: 0 0 55%; min-height: 100px; overflow-y: auto; position: relative; background: white; }
        .drag-handle { 
            height: 12px; 
            background: #f8fafc; 
            cursor: ns-resize; 
            display: flex; 
            align-items: center; 
            justify-content: center;
            border-top: 1px solid #e2e8f0;
            border-bottom: 1px solid #e2e8f0;
            flex-shrink: 0;
            z-index: 40;
            touch-action: none;
        }
        .drag-handle::after { 
            content: ""; 
            width: 48px; 
            height: 4px; 
            background: #cbd5e1; 
            border-radius: 2px; 
        }
        .panel-ai { flex: 1; min-height: 100px; overflow-y: auto; background: #fafafa; display: flex; flex-direction: column; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.4s ease-out forwards; }
        .sidebar-transition { transition: width 0.3s ease-in-out, opacity 0.2s ease-in-out; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const BLOCKS = [
            {
                id: 1, title: "Block 1: Källkritik", icon: "sparkles", sections: [
                    {
                        title: "A: Skröna & Gustav Vasa", page: "8–9",
                        text: "Boksida: 8–9\n\nI ämnet historia läser du om hur det var förr i tiden. Vad hände i Sverige 1520 till exempel, när Gustav Eriksson irrade omkring i Dalarna, jagad av den danske kungen Kristian Tyranns soldater? Så här stod det i Läsebok för folkskolan – alla barn i hela Sverige läste förr om hur bonden Sven Elvsson i Isala i Dalarna räddade livet på Gustav Eriksson.\n\n'Sven Elvsson menade att Gustav nog inte var säker i Isala. Han gömde honom därför i ett stort halmlass och körde det uppåt de ödsliga skogarna. Snart mötte han några av danskarnas utskickade soldater. De misstänkte bonden och stack sina spjut några gånger genom halmlasset. En av spjutspetsarna rispade Gustav i benet, men han låg orörlig. Danskarna märkte ingenting och lät Sven Elvsson köra vidare. Snart såg Sven att blod började rinna ur halmlasset och färga snön. Sven blev rädd att blodet skulle avslöja dem. Han tog därför upp sin kniv, skar ett djupt hål i benet på hästen. När Sven sedan blev tillfrågad om blodfläckarna i snön, skyllde han på hästens sår.'\n\nVisst är det en spännande historia! Men är den sann? Gustav III beundrade Gustav Vasa och ville gärna visa att de var släkt. Kungen beordrade därför landshövdingen i Dalarna att hitta personer som kunde skriva ned Gustav Vasas 'äventyr'. Berättelserna skrevs alltså ner 250 år senare och kallas ofta för skrönor. En skröna kan ha en kärna av sanning men är sedan överdriven och förljugen. Källkritik hjälper oss att fråga: Vem berättar? Varför? Och när hände det?",
                        concepts: ["Källkritik", "Skröna", "Propaganda", "Historiker"],
                        mustKnow: ["Vad en skröna är.", "Att Vasa-berättelsen kom 250 år efteråt.", "Varför kungar använde historier för makt."],
                        summary: ["Källkritik granskar information.", "Skrönor är överdrivna historier.", "Syftet med Isala-berättelsen var att hylla kungen."],
                        test: [{q: "Vad kallas en överdriven historia?", a: "Skröna"}, {q: "Vem beställde texten 250 år senare?", a: "Gustav III"}],
                        reasoning: "Varför ville en kung sprida hjältesagor om sina förfäder?",
                        application: "Hitta en rubrik på nätet och ställ källfrågorna."
                    },
                    {
                        title: "B: Källfrågorna", page: "10",
                        text: "Boksida: 10\n\nFör att granska en källa använder vi källkritik. Det finns fyra viktiga grundfrågor som du alltid ska ha med dig:\n\n1. Äkthet: Är källan vad den utger sig för att vara? Är det ett riktigt brev från medeltiden eller en förfalskning gjord igår? I den digitala världen kan bilder och filmer enkelt ändras så att de ser äkta ut trots att de är fejk.\n\n2. Tid: När skapades källan? Det är bäst om den skapades precis när något hände. Ju längre tid som går, desto mer glömmer vi bort eller råkar ändra på detaljer i vår berättelse. En person som berättar om något idag som hände för 20 år sedan är inte lika pålitlig som en dagbok skriven samma dag.\n\n3. Beroende: Berättar källan något helt själv eller har den bara skrivit av någon annan? Om tre tidningar skriver samma sak men alla har tagit informationen från samma person, så finns det egentligen bara en enda källa.\n\n4. Syfte (Tendens): Vad vill författaren uppnå? Vill hen informera om sanningen, eller vill hen sälja något eller påverka dig? Om en källa är vinklad kallas det att den har en tendens.",
                        concepts: ["Äkthet", "Tid", "Beroende", "Tendens"],
                        mustKnow: ["De fyra källfrågorna.", "Tidens påverkan på minnet.", "Vad beroende innebär."],
                        summary: ["Äkthet, Tid, Beroende och Syfte.", "Information nära händelsen är bäst.", "Var vaksam på tendens."],
                        test: [{q: "Vilken är första källfrågan?", a: "Äkthet"}, {q: "Vad betyder tendens?", a: "Vinklad information"}],
                        reasoning: "Vilken fråga är svårast på internet?",
                        application: "Granska ett inlägg på sociala medier."
                    }
                ]
            },
            {
                id: 2, title: "Block 2: Ekonomi", icon: "zap", sections: [
                    {
                        title: "A: Pengar & Historia", page: "43–44",
                        text: "Boksida: 43–44\n\nSkulle vi klara oss utan pengar? Byteshandel har funnits så länge människan har funnits. Det betyder att man byter en vara mot en annan, t.ex. en ko mot en säck säd. Men det är krångligt att bära med sig tunga saker för att handla. För några tusen år sedan uppfanns därför pengar för att mäta värde.\n\nI Sverige var de första mynten av metall och de skulle vara värda precis lika mycket som själva metallen vägde. På 1600-talet blev det brist på guld och silver. Då började man använda koppar istället. Men koppar var billigare än guld, så mynten var tvungna att vara enormt stora och tunga. De tyngsta kopparmynten vägde över 19 kilo! Folk fick dra sina pengar på skottkärra till marknaden. År 1660 öppnade Johan Palmstruch den första banken i Stockholm. Han lät folk lämna in sina tunga mynt. Som bevis fick de ett kvitto på papper – dessa kvitton blev Sveriges första sedlar. Idag är de flesta pengar elektroniska digitala siffror.",
                        concepts: ["Byteshandel", "Metallen", "Johan Palmstruch", "Kontanter"],
                        mustKnow: ["Varför pengar uppfanns.", "Svenska mynt vägde 19 kg.", "Första banken 1660."],
                        summary: ["Pengar ersatte krånglig byteshandel.", "Första sedlarna var bankkvitton.", "Idag är pengar främst digitala."],
                        test: [{q: "Vad vägde tunga mynt?", a: "19 kg"}, {q: "Vem startade första banken?", a: "Johan Palmstruch"}],
                        reasoning: "Vad händer om internet slutar funka?",
                        application: "Designa ett eget mynt."
                    },
                    {
                        title: "B: Brutto & Netto", page: "46–47",
                        text: "Boksida: 46–47\n\nNär en vuxen person arbetar får hen lön. Men man får inte behålla alla pengar själv. Bruttolön är lönen före skatten är dragen. I Sverige betalar vi inkomstskatt till staten och kommunen, ofta ca 30%. Om en person tjänar 30 000 kr i bruttolön dras ca 9 000 kr i skatt. Det som blir kvar kallas nettolön. Det är nettolönen man använder för att betala mat och hyra. \n\nSkattepengarna går till den offentliga sektorn. Det är saker vi äger tillsammans. Det betalar för skolor, lärare, sjukhus, poliser och vägar. Det betalar också för domstolar och försvaret. Utöver lön kan ett hushåll få bidrag, som barnbidrag som föräldrar får varje månad. Genom skatten kan vi ha en bra service som fungerar för alla.",
                        concepts: ["Bruttolön", "Nettolön", "Offentlig sektor", "Inkomstskatt"],
                        mustKnow: ["Brutto vs Netto.", "Skatten är ca 30%.", "Vad skatten betalar."],
                        summary: ["Bruttolön = före skatt, Netto = efter skatt.", "Skatten betalar skola och vård.", "Offentliga sektorn är gemensam."],
                        test: [{q: "Vad kallas lönen före skatt?", a: "Bruttolön"}, {q: "Vart går skatten?", a: "Offentlig sektor"}],
                        reasoning: "Varför betalar vi inkomstskatt?",
                        application: "Räkna ut netto om brutto är 100 kr."
                    }
                ]
            },
            {
                id: 3, title: "Block 3: Banker & Priser", icon: "landmark", sections: [
                    {
                        title: "A: Banker & Mellanhänder", page: "52",
                        text: "Boksida: 52\n\nBanker fungerar som en mellanhand mellan sparare och lånare. De pengar en bank har kommer från privatpersoner och företag som sparar. När du sätter in pengar lånar du ut dem till banken. Banken samlar ihop summor från många sparare och lånar ut dem till familjer som vill köpa hus eller företag som vill växa. Banken tjänar pengar på ränta. Skillnaden mellan den ränta du får för ditt sparande (inlåning) och den ränta lånaren betalar (utlåning) kallas räntegap. Detta är bankens vinst.",
                        concepts: ["Sparande", "Låntagare", "Räntegap", "Mellanhand"],
                        mustKnow: ["Bankens roll som förmedlare.", "Hur banken tjänar pengar.", "Vikten av sparande."],
                        summary: ["Banker flyttar pengar från sparare till lånare.", "Räntegapet täcker bankens kostnader.", "Lån möjliggör stora köp."],
                        test: [{q: "Vad kallas bankens vinst?", a: "Räntegap"}, {q: "Vem lånar ut till banken?", a: "Spararen"}],
                        reasoning: "Varför är det viktigt att banken granskar de som lånar?",
                        application: "Förklara räntegapet för en kompis."
                    }
                ]
            },
            {
                id: 5, title: "Block 5: Demokrati", icon: "users", sections: [
                    {
                        title: "A: Demokrati i Aten", page: "75",
                        text: "Boksida: 75\n\nDemokrati betyder folkstyre. Ordet kommer från grekiskans 'demos' (folk) och 'kratos' (styre). För cirka 2500 år sedan skapades den första demokratin i Aten. Där fick fria män som var medborgare träffas på en plats som hette Pnyx för att rösta direkt om stadens lagar. Det kallas direkt demokrati. \n\nMen Aten var ingen perfekt demokrati med våra mått mätt. Kvinnor, slavar och inflyttade utlänningar fick inte rösta. De flesta som bodde i Aten hade alltså inget att säga till om. Idag har vi representativ demokrati. Vi väljer representanter (politiker) som vi litar på och som fattar besluten åt oss i riksdagen.",
                        concepts: ["Direkt demokrati", "Pnyx", "Representativ", "Folkstyre"],
                        mustKnow: ["Ordets grekiska rötter.", "Skillnaden på direkt och representativ.", "Vem som uteslöts i Aten."],
                        summary: ["Demokrati = Folkstyre.", "Startade i Aten för 2500 år sedan.", "Sverige har representativ demokrati."],
                        test: [{q: "Vad betyder 'demos'?", a: "Folk"}, {q: "Var låg världens första demokrati?", a: "Aten"}],
                        reasoning: "Varför räknas Aten som en demokrati trots att kvinnor inte fick rösta?",
                        application: "Hitta exempel på direkt demokrati i din skola."
                    },
                    {
                        title: "B: Spelregler & Pelare", page: "76–77",
                        text: "Boksida: 76–77\n\nFör att ett land ska få kallas för en demokrati krävs mer än bara val. Det finns fyra viktiga grundpelare:\n\n1. Fria och hemliga val: Ingen får se vad du röstar på och ingen får tvinga dig. Valen sker regelbundet.\n2. Yttrandefrihet och tryckfrihet: Du har rätt att tycka, tänka och skriva vad du vill. Staten får inte censurera nyheter eller internet för att dölja sanningen.\n3. Rättssäkerhet: Alla är lika inför lagen. Man kan inte straffas utan en rättvis rättegång, och domstolen får inte styras av politiker.\n4. Majoritetsprincipen: Det förslag som får flest röster vinner. Men man måste samtidigt skydda minoriteter (de som tycker annorlunda) så att de inte förtrycks av de som är flest.\n\nUtan dessa pelare är det ingen riktig demokrati.",
                        concepts: ["Hemliga val", "Rättssäkerhet", "Majoritet", "Minoritet"],
                        mustKnow: ["De fyra grundpelarna.", "Varför hemliga val är nödvändiga.", "Skillnaden på majoritet och minoritet."],
                        summary: ["Pelarna skyddar folkets rättigheter.", "Lagen gäller lika för alla.", "Yttrandefrihet är grunden för debatt."],
                        test: [{q: "Måste man berätta vad man röstat på?", a: "Nej"}, {q: "Vem bestämmer i en röstning?", a: "Majoriteten"}],
                        reasoning: "Vad händer om en domstol styrs av en kung eller president?",
                        application: "Gör en checklista för ett demokratiskt land."
                    },
                    {
                        title: "C: Diktaturens Makt", page: "78–79",
                        text: "Boksida: 78–79\n\nI en diktatur bestämmer en person (diktator) eller en liten grupp allt. I en diktatur fungerar samhället genom kontroll och rädsla:\n\n* Censur: Staten kontrollerar TV och internet. Man får bara säga det som diktatorn gillar.\n* Inga fria val: Ofta finns bara ett parti. Om det finns fler val fuskar man med rösterna så att ledaren alltid vinner.\n* Rättsosäkerhet: Polisen lyder diktatorn och kan fängsla folk utan bevis.\n* Rädsla: Folk vågar inte protestera eftersom de riskerar att straffas eller försvinna.\n\nMånga diktaturer försöker dölja att de är diktaturer genom att använda fina ord, men om folket inte har yttrandefrihet är det ingen demokrati.",
                        concepts: ["Diktator", "Censur", "Rättsosäkerhet", "Kontroll"],
                        mustKnow: ["Kännetecken för en diktatur.", "Hur censur fungerar.", "Skillnaden mot rättssäkerhet."],
                        summary: ["En ledare har all makt.", "Ingen yttrandefrihet.", "Staten styr domstolar och poliser."],
                        test: [{q: "Vad kallas kontroll av TV?", a: "Censur"}, {q: "Får man tycka fritt i en diktatur?", a: "Nej"}],
                        reasoning: "Varför förbjuder diktaturer ofta sociala medier?",
                        application: "Jämför en dag i en skola i en diktatur mot en i en demokrati."
                    }
                ]
            },
            {
                id: 6, title: "Block 6: Riksdag & Regering", icon: "landmark", sections: [
                    {
                        title: "A: Riksdagen & Pengarna", page: "84–85",
                        text: "Boksida: 84–85\n\nRiksdagen har 349 ledamöter valda av folket. Riksdagens två viktigaste uppgifter är att stifta lagar och besluta om statens budget. Budgeten är en plan för hur skattepengarna ska användas. Det handlar om hundratals miljarder som ska fördelas till skola, sjukvård, polis och försvar. Riksdagen kontrollerar också regeringen. Om riksdagen inte längre litar på statsministern kan de rösta för att avsätta regeringen genom en misstroendeförklaring.",
                        concepts: ["Ledamot", "Statens budget", "Lagstiftning", "Misstroende"],
                        mustKnow: ["Antal ledamöter (349).", "Huvuduppgifterna lagar och pengar.", "Kontroll av regeringen."],
                        summary: ["Riksdagen representerar folket.", "De bestämmer om lagar och pengar.", "De kontrollerar regeringen."],
                        test: [{q: "Hur många sitter i riksdagen?", a: "349"}, {q: "Vad är budgeten?", a: "En plan för pengar"}],
                        reasoning: "Varför är det viktigt att riksdagen bestämmer över pengarna?",
                        application: "Namnge tre partier i riksdagen."
                    },
                    {
                        title: "B: Från Förslag till Lag", page: "86",
                        text: "Boksida: 86\n\nAtt skapa en ny lag tar tid. Det börjar med ett förslag. Om förslaget kommer från regeringen kallas det proposition. Om det kommer från en riksdagsledamot kallas det motion. Förslaget skickas först till ett utskott (experter på området) som skriver ett betänkande. Sedan debatteras förslaget i kammaren innan de 349 ledamöterna röstar. Om en majoritet röstar ja, ser regeringen till att lagen börjar gälla.",
                        concepts: ["Proposition", "Motion", "Utskott", "Kammaren"],
                        mustKnow: ["Skillnad på proposition och motion.", "Utskottens roll.", "Hur röstningen går till."],
                        summary: ["Proposition = Regering, Motion = Ledamot.", "Utskotten förbereder besluten.", "Majoriteten avgör."],
                        test: [{q: "Vad är en proposition?", a: "Förslag från regeringen"}, {q: "Var arbetar experterna?", a: "I utskotten"}],
                        reasoning: "Varför skickas förslag till utskott istället för att rösta direkt?",
                        application: "Hitta på en egen 'klassmotion'."
                    }
                ]
            },
            {
                id: 7, title: "Block 7: Framtiden", icon: "briefcase", sections: [
                    {
                        title: "A: Samhällsförändring", page: "29–30",
                        text: "Boksida: 29–30\n\nArbetsmarknaden i Sverige har ändrats enormt. För 200 år sedan jobbade nästan alla svenskar med jordbruk. Man bodde på landet och tillverkade det mesta själv. När industrialiseringen kom byggdes fabriker och folk flyttade till städerna. Idag lever vi i ett tjänstesamhälle där de flesta jobbar inom vård, skola, handel eller teknik. Utbildning har blivit mycket viktigare för att få ett jobb idag än förr.",
                        concepts: ["Industrialisering", "Tjänstesamhälle", "Utbildning"],
                        mustKnow: ["Från jordbruk till tjänster.", "Vikten av utbildning idag.", "Städernas växt."],
                        summary: ["Förr jobbade folk med jordbruk.", "Idag jobbar de flesta med tjänster.", "Jobben kräver mer kunskap idag."],
                        test: [{q: "Vad jobbade folk med förr?", a: "Jordbruk"}, {q: "Vad kallas dagens samhälle?", a: "Tjänstesamhälle"}],
                        reasoning: "Hur såg dina morföräldrars jobb ut?",
                        application: "Intervjua en vuxen om deras första jobb."
                    },
                    {
                        title: "B: Robotar & AI", page: "31–34",
                        text: "Boksida: 31–34\n\nTekniken ändrar jobben genom mekanisering (maskiner tar tunga lyft) och digitalisering (datorer styr). Robotar finns i fabriker och jobbar dygnet runt utan att bli trötta. AI (artificiell intelligens) är program som kan lära sig själva. AI används redan i sjukvården för att hitta sjukdomar, som hudcancer, och styr självkörande bilar. Yrken med mänsklig kontakt (lärare, frisör) kommer finnas kvar, men verktygen kommer ändras.",
                        concepts: ["Mekanisering", "AI", "Robotisering"],
                        mustKnow: ["Teknikens påverkan på jobb.", "Vad AI står för.", "AI i vården."],
                        summary: ["Robotar tar tunga jobb.", "AI är smarta datorer.", "Mänskliga yrken behövs fortfarande."],
                        test: [{q: "Vad står AI för?", a: "Artificiell intelligens"}, {q: "Vilka jobb försvinner?", a: "Tunga/enformiga"}],
                        reasoning: "Kan en robot bli din lärare?",
                        application: "Leta efter en robot i din vardag."
                    }
                ]
            }
        ];

        function App() {
            const [activeBlock, setActiveBlock] = useState(0);
            const [activeSection, setActiveSection] = useState(0);
            const [aiChat, setAiChat] = useState([]);
            const [isLoading, setIsLoading] = useState(false);
            const [splitPercent, setSplitPercent] = useState(55);
            const [isTeacherMode, setIsTeacherMode] = useState(false);
            const [isSidebarOpen, setIsSidebarOpen] = useState(true);
            const [history, setHistory] = useState([]);
            const [showDetail, setShowDetail] = useState(null);

            const splitRef = useRef(null);
            const isDragging = useRef(false);

            const block = BLOCKS[activeBlock];
            const section = block.sections[activeSection];

            const onStartDragging = (e) => { isDragging.current = true; document.body.style.cursor = 'ns-resize'; e.preventDefault(); };
            const onEndDragging = () => { isDragging.current = false; document.body.style.cursor = 'default'; };
            const onDragging = (e) => {
                if (!isDragging.current) return;
                const rect = splitRef.current.getBoundingClientRect();
                const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                const y = clientY - rect.top;
                let p = (y / rect.height) * 100;
                if (p < 15) p = 15; if (p > 85) p = 85;
                setSplitPercent(p);
            };

            const askAI = async (type, queryText = "") => {
                setIsLoading(true);
                const userMsg = { role: 'user', content: queryText || (type === 'simplify' ? 'Förenkla' : type === 'deepen' ? 'Fördjupa' : 'Exempel') };
                setAiChat(prev => [...prev, userMsg]);

                let sysPrompt = "";
                let q = "";

                if (type === 'simplify') {
                    sysPrompt = `Du är en pedagogisk assistent för 12-åringar. DIN TEXTBANK: "${section.text}" (Sida ${section.page}). DITT UPPDRAG: Förenkla språket extremt mycket. REGLER: 1) Skriv KORTA stycken. 2) Använd PUNKTLYSTOR om möjligt. 3) Förklara svåra ord direkt. 4) Använd bara fakta från texten. 5) Sluta med "Källa: sida ${section.page}".`;
                    q = "Gör texten jättelätt att förstå. Skriv kort och tydligt.";
                } else if (type === 'deepen') {
                    sysPrompt = `Du är en avancerad pedagogisk coach. DIN TEXTBANK: "${section.text}" (Sida ${section.page}). DITT UPPDRAG: Fördjupa förståelsen. REGLER: 1) Fokusera på SAMBAND (varför leder A till B?). 2) Diskutera KONSEKVENSER för individ och samhälle. 3) Ställ en utmanande följdfråga. 4) Använd bara fakta från texten. 5) Sluta med "Källa: sida ${section.page}".`;
                    q = "Hjälp mig fördjupa mig i samband och konsekvenser i texten.";
                } else {
                    sysPrompt = `Du är Studiekompisen AI för årskurs 6. DIN TEXTBANK: "${section.text}" (Sida ${section.page}). REGLER: 1) Endast fakta från texten. 2) Coacha med frågor. 3) Sluta med "Källa: sida ${section.page}".`;
                    q = queryText || "Ge ett vardagligt exempel på innehållet.";
                }

                try {
                    const res = await fetch(`/.netlify/functions/gemini`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ q, systemPrompt: sysPrompt, model: MODEL })
                    });
                    if (!res.ok) throw new Error("API-anslutningsfel");
                    const data = await res.json();
                    const aiResponse = data.candidates?.[0]?.content?.parts?.[0]?.text || "Kunde inte hämta svar.";
                    setAiChat(prev => [...prev, { role: 'ai', content: aiResponse }]);
                    setHistory(prev => [...prev, { s: section.page, q: q, a: aiResponse }]);
                } catch (err) {
                    setAiChat(prev => [...prev, { role: 'ai', content: "Hoppsan! Kunde inte hämta svar nu. Se till att appen körs via Netlify." }]);
                } finally {
                    setIsLoading(false);
                }
            };

            return (
                <div className="flex w-full h-full text-left" onMouseMove={onDragging} onMouseUp={onEndDragging} onTouchMove={onDragging} onTouchEnd={onEndDragging}>
                    <aside className={`bg-white border-r flex flex-col shrink-0 z-50 sidebar-transition ${isSidebarOpen ? 'w-80 opacity-100' : 'w-0 opacity-0 overflow-hidden'}`}>
                        <div className="p-8 bg-indigo-700 text-white">
                            <div className="flex items-center gap-3">
                                <span className="bg-white p-2 rounded-lg text-indigo-700"><i data-lucide="graduation-cap"></i></span>
                                <h1 className="text-xl font-black uppercase italic leading-none">Studiekompisen</h1>
                            </div>
                            <p className="text-[10px] mt-2 opacity-70 uppercase font-bold tracking-widest text-left">Utkik SO Åk 6</p>
                        </div>
                        <nav className="flex-1 p-4 overflow-y-auto custom-scrollbar space-y-1">
                            {BLOCKS.map((b, i) => (
                                <button key={i} onClick={() => { setActiveBlock(i); setActiveSection(0); setAiChat([]); }}
                                    className={`w-full flex items-center gap-3 p-4 rounded-2xl transition-all font-bold text-xs ${activeBlock === i ? 'bg-indigo-50 text-indigo-700' : 'text-slate-500 hover:bg-slate-50'}`}>
                                    <span className="p-2 bg-slate-100 rounded-lg"><i data-lucide={b.icon} className="w-4 h-4 text-left"></i></span>
                                    <span className="whitespace-nowrap">{b.title}</span>
                                </button>
                            ))}
                        </nav>
                        <div className="p-4 border-t">
                            <button onClick={() => setIsTeacherMode(!isTeacherMode)} className="w-full p-3 rounded-xl bg-slate-50 text-slate-400 text-[10px] font-black uppercase tracking-widest flex justify-between items-center text-left">
                                Lärarlogg <i data-lucide={isTeacherMode ? "eye" : "eye-off"} className="w-3 h-3 text-left"></i>
                            </button>
                        </div>
                    </aside>

                    <main className="flex-1 flex flex-col relative bg-white overflow-hidden" ref={splitRef}>
                        <header className="bg-white/90 border-b p-4 flex items-center justify-between z-10 shrink-0">
                            <div className="flex items-center gap-4 overflow-hidden">
                                <button onClick={() => setIsSidebarOpen(!isSidebarOpen)} className="p-2 bg-slate-100 hover:bg-slate-200 rounded-lg text-slate-600 shrink-0"><i data-lucide={isSidebarOpen ? "panel-left-close" : "panel-left-open"}></i></button>
                                <div className="flex gap-2 overflow-x-auto no-scrollbar">
                                    {block.sections.map((s, i) => (
                                        <button key={i} onClick={() => { setActiveSection(i); setAiChat([]); setShowDetail(null); }}
                                            className={`px-4 py-2 rounded-full text-[10px] font-black uppercase tracking-widest whitespace-nowrap transition-all ${activeSection === i ? 'bg-indigo-600 text-white shadow-md' : 'bg-slate-100 text-slate-400 hover:bg-slate-200'}`}>
                                            {s.title}
                                        </button>
                                    ))}
                                </div>
                            </div>
                            <div className="bg-indigo-50 text-indigo-600 px-4 py-1.5 rounded-full text-[10px] font-black uppercase whitespace-nowrap border border-indigo-100 ml-2">Sida {section.page}</div>
                        </header>

                        <div className="split-container">
                            <div className="panel-text custom-scrollbar" style={{ flexBasis: `${splitPercent}%` }}>
                                <div className="max-w-4xl mx-auto p-8 space-y-12 pb-20 text-left">
                                    <section className="bg-amber-50 p-10 rounded-[3rem] border-4 border-amber-100 shadow-xl relative overflow-hidden">
                                        <h4 className="text-[10px] font-black text-amber-700 uppercase tracking-widest mb-6 flex items-center gap-2 italic text-left">
                                            <i data-lucide="check-circle-2" className="w-4 h-4"></i> Detta behöver du kunna
                                        </h4>
                                        <ul className="space-y-3">{section.mustKnow.map((m, i) => <li key={i} className="flex gap-4 font-bold text-amber-900 leading-snug"><span className="text-amber-400">▶</span> {m}</li>)}</ul>
                                    </section>

                                    <section className="bg-white p-12 rounded-[4rem] shadow-2xl border border-slate-100 relative animate-fade-in text-left">
                                        <div className="absolute top-0 left-0 w-2 h-full bg-indigo-600"></div>
                                        <p className="text-2xl leading-[1.8] text-slate-700 font-bold whitespace-pre-wrap">{section.text}</p>
                                        <div className="mt-14 pt-10 border-t-2 border-slate-50 text-left">
                                            <p className="text-[10px] font-black text-slate-400 uppercase mb-5">Begrepp (klicka för förklaring):</p>
                                            <div className="flex flex-wrap gap-2 text-left">{section.concepts.map((c, i) => <button key={i} onClick={() => askAI('concept', c)} className="px-5 py-2.5 bg-indigo-50 text-indigo-700 rounded-2xl text-[10px] font-black uppercase tracking-widest hover:bg-indigo-600 hover:text-white transition-all border border-indigo-100">{c}</button>)}</div>
                                        </div>
                                    </section>

                                    <section className="grid grid-cols-1 md:grid-cols-3 gap-6 font-black uppercase text-[10px] tracking-widest text-left">
                                        <button onClick={() => setShowDetail('summary')} className="p-10 rounded-[2.5rem] border-4 border-slate-100 bg-white text-slate-400 flex flex-col items-center gap-4 hover:border-indigo-200 transition-all text-center"><i data-lucide="list-checks" className="w-10 h-10"></i> Sammanfattning</button>
                                        <button onClick={() => setShowDetail('test')} className="p-10 rounded-[2.5rem] border-4 border-slate-100 bg-white text-slate-400 flex flex-col items-center gap-4 hover:border-blue-200 transition-all text-center"><i data-lucide="zap" className="w-10 h-10"></i> Självtest</button>
                                        <button onClick={() => setShowDetail('reasoning')} className="p-10 rounded-[2.5rem] border-4 border-slate-100 bg-white text-slate-400 flex flex-col items-center gap-4 hover:border-emerald-200 transition-all text-center"><i data-lucide="brain-circuit" className="w-10 h-10"></i> Resonera</button>
                                    </section>

                                    {showDetail && (
                                        <div className="bg-slate-50 p-12 rounded-[3.5rem] border-2 border-slate-100 animate-fade-in text-left">
                                            {showDetail === 'summary' && <ul className="space-y-4">{section.summary.map((s, i) => <li key={i} className="bg-white p-7 rounded-3xl font-bold flex gap-5 shadow-sm border border-slate-100 text-left"><span className="text-indigo-500 font-black">0${i+1}</span>{s}</li>)}</ul>}
                                            {showDetail === 'test' && <div className="grid grid-cols-1 md:grid-cols-2 gap-4">{section.test.map((t, i) => <div key={i} className="bg-white p-6 rounded-3xl border border-blue-50 shadow-sm flex flex-col justify-between italic text-sm font-black text-slate-800 text-left">"{t.q}"<button onClick={(e) => { e.currentTarget.innerHTML = `<span class='text-blue-600 font-black'>${t.a}</span>`; }} className="text-[9px] text-blue-300 uppercase mt-4 text-left">Visa svar</button></div>)}</div>}
                                            {showDetail === 'reasoning' && <div className="bg-white p-12 rounded-[3rem] italic font-black text-2xl text-slate-700 text-center leading-relaxed">"{section.reasoning}"<button onClick={() => askAI('develop')} className="bg-emerald-600 text-white px-10 py-4 rounded-full text-xs font-black mt-10 uppercase tracking-widest block mx-auto text-center shadow-lg">Hjälp mig tänka vidare</button></div>}
                                        </div>
                                    )}

                                    <section className="bg-slate-900 text-white p-12 rounded-[4rem] shadow-2xl relative overflow-hidden group text-left">
                                        <h4 className="text-[10px] font-black text-indigo-400 uppercase tracking-widest mb-6 italic text-left">Tillämpning: Gör detta nu</h4>
                                        <p className="text-2xl font-bold leading-snug tracking-tight">{section.application}</p>
                                    </section>
                                </div>
                            </div>

                            <div className="drag-handle" onMouseDown={onStartDragging} onTouchStart={onStartDragging}></div>

                            <div className="panel-ai custom-scrollbar p-8">
                                <div className="max-w-4xl mx-auto w-full space-y-6 text-left">
                                    <div className="flex gap-3 overflow-x-auto no-scrollbar pb-1 text-left">
                                        <button onClick={() => askAI('simplify')} className="bg-blue-600 text-white px-6 py-4 rounded-2xl text-[10px] font-black uppercase tracking-widest flex items-center gap-3 shadow-lg shrink-0 text-left"><i data-lucide="sparkles" className="w-4 h-4"></i> Förenkla texten</button>
                                        <button onClick={() => askAI('deepen')} className="bg-emerald-600 text-white px-6 py-4 rounded-2xl text-[10px] font-black uppercase tracking-widest flex items-center gap-3 shadow-lg shrink-0 text-left"><i data-lucide="brain" className="w-4 h-4"></i> Fördjupa & samband</button>
                                        <button onClick={() => askAI('example')} className="bg-slate-900 text-white px-6 py-4 rounded-2xl text-[10px] font-black uppercase tracking-widest flex items-center gap-3 shadow-lg shrink-0 text-left text-left"><i data-lucide="message-square" className="w-4 h-4 text-left"></i> Ge exempel</button>
                                    </div>
                                    {aiChat.map((m, i) => (
                                        <div key={i} className={`flex ${m.role === 'user' ? 'justify-end text-right' : 'justify-start text-left'} animate-fade-in`}>
                                            <div className={`max-w-[85%] p-7 rounded-[2rem] text-sm font-bold shadow-xl leading-relaxed ${m.role === 'user' ? 'bg-indigo-600 text-white rounded-tr-none text-right' : 'bg-white border-2 border-slate-50 text-slate-800 rounded-tl-none'}`}>
                                                {m.role === 'ai' && <div className="text-[9px] uppercase tracking-widest text-indigo-500 mb-3 font-black opacity-60 text-left text-left">Studiekompisen AI</div>}
                                                <div className="whitespace-pre-wrap">{m.content}</div>
                                            </div>
                                        </div>
                                    ))}
                                    {isLoading && <div className="flex justify-start text-left"><div className="bg-white p-6 rounded-[2rem] flex items-center gap-5 shadow-xl text-left"><div className="w-6 h-6 border-2 border-indigo-600 border-t-transparent rounded-full animate-spin text-left text-left"></div><span className="text-[10px] font-black text-indigo-400 uppercase animate-pulse italic text-left">Studerar boken...</span></div></div>}
                                </div>
                            </div>
                        </div>
                    </main>

                    {isTeacherMode && (
                        <div className="fixed inset-0 bg-slate-900/80 backdrop-blur-2xl z-[100] flex items-center justify-center p-10 text-left">
                            <div className="bg-white w-full max-w-6xl h-[90vh] rounded-[5rem] flex flex-col overflow-hidden border-4 border-white shadow-2xl">
                                <header className="p-14 border-b flex justify-between items-center bg-slate-50/50 text-left text-left text-left">
                                    <h2 className="text-4xl font-black uppercase italic text-slate-900 leading-none">Kontrollpanel</h2>
                                    <button onClick={() => setIsTeacherMode(false)} className="bg-white p-5 rounded-full border-2 border-slate-100 hover:text-red-500 transition-all shadow-sm text-left"><i data-lucide="x"></i></button>
                                </header>
                                <div className="flex-1 overflow-y-auto p-14 custom-scrollbar">
                                    <table className="w-full text-left text-left text-left">
                                        <thead className="bg-slate-50 text-[11px] font-black text-slate-500 uppercase italic border-b-4 border-white"><tr><th className="p-10 text-left">Sida</th><th className="p-10 text-left">Input</th><th className="p-10 text-left">Svar</th></tr></thead>
                                        <tbody className="text-base font-bold text-slate-600 divide-y-4 divide-slate-50 text-left">
                                            {history.map((h, i) => (
                                                <tr key={i} className="hover:bg-indigo-50/30 transition-colors">
                                                    <td className="p-10 text-xs font-black italic whitespace-nowrap">SIDA {h.s}</td>
                                                    <td className="p-10 italic text-slate-900 text-lg text-left text-left">"{h.q}"</td>
                                                    <td className="p-10 text-sm font-medium opacity-60 leading-relaxed max-w-lg text-left text-left text-left">{h.a}</td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
        setTimeout(() => { if (window.lucide) window.lucide.createIcons(); }, 100);
    </script>
</body>
</html>
